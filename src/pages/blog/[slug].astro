---
import BaseLayout from '@/layouts/BaseLayout.astro';
import BlogArticleApp from '@/components/app/BlogArticleApp';
import { supabase } from '@/integrations/supabase/client';

export const prerender = false;

const { slug } = Astro.params;

// Fetch post server-side for SEO meta tags
let title = "Article | VerifierMonDevis.fr";
let description = "Article du blog VerifierMonDevis.fr";
let ogImage: string | undefined;
let jsonLd: object | undefined;
let postTitle = "Article";

if (slug) {
  const { data: post } = await supabase
    .from("blog_posts")
    .select("title, seo_title, seo_description, excerpt, cover_image_url, published_at, updated_at")
    .eq("slug", slug)
    .eq("status", "published")
    .single();

  if (post) {
    postTitle = post.title;
    title = `${post.seo_title || post.title} | VerifierMonDevis.fr`;
    description = post.seo_description || post.excerpt || description;
    ogImage = post.cover_image_url || undefined;
    jsonLd = {
      "@context": "https://schema.org",
      "@type": "Article",
      "headline": post.title,
      "description": post.seo_description || post.excerpt || "",
      "datePublished": post.published_at,
      "dateModified": post.updated_at || post.published_at,
      "author": { "@type": "Organization", "name": "VerifierMonDevis.fr" },
      "publisher": {
        "@type": "Organization",
        "name": "VerifierMonDevis.fr",
        "logo": { "@type": "ImageObject", "url": "https://verifiermondevis.fr/images/logo-header.png" }
      },
      "mainEntityOfPage": { "@type": "WebPage", "@id": `https://verifiermondevis.fr/blog/${slug}` },
      ...(post.cover_image_url ? { "image": post.cover_image_url } : {}),
    };
  }
}
---

<BaseLayout
  title={title}
  description={description}
  canonical={`https://verifiermondevis.fr/blog/${slug}`}
  ogType="article"
  ogImage={ogImage}
  jsonLd={jsonLd}
  breadcrumbs={[
    { name: "Accueil", url: "https://verifiermondevis.fr/" },
    { name: "Blog", url: "https://verifiermondevis.fr/blog" },
    { name: postTitle, url: `https://verifiermondevis.fr/blog/${slug}` }
  ]}
>
  <BlogArticleApp client:only="react" />
</BaseLayout>
