---
import BaseLayout from '@/layouts/BaseLayout.astro';
import AstroHeader from '@/components/astro/Header.astro';
import AstroFooter from '@/components/astro/Footer.astro';
import SimulateurScoresApp from '@/components/app/SimulateurScoresApp';

const jsonLd = {
  "@context": "https://schema.org",
  "@type": "WebApplication",
  "name": "Simulateur de valorisation des travaux immobiliers",
  "description": "Calculez la revalorisation estim√©e de votre bien selon vos postes de travaux, avec analyse du risque de surcapitalisation.",
  "url": "https://www.verifiermondevis.fr/simulateur-valorisation-travaux",
  "applicationCategory": "UtilitiesApplication",
  "operatingSystem": "Web",
  "offers": { "@type": "Offer", "price": "0", "priceCurrency": "EUR" }
};
---

<BaseLayout
  title="Simulateur de valorisation des travaux immobiliers | VerifierMonDevis.fr"
  description="Estimez la revalorisation de votre bien poste par poste. Calcul multi-travaux, analyse de surcapitalisation, impact locatif. Gratuit, sans inscription."
  canonical="https://www.verifiermondevis.fr/simulateur-valorisation-travaux"
  ogType="article"
  jsonLd={jsonLd}
  breadcrumbs={[
    { name: "Accueil",                  url: "https://www.verifiermondevis.fr/" },
    { name: "Valorisation des travaux", url: "https://www.verifiermondevis.fr/valorisation-travaux-immobiliers" },
    { name: "Simulateur",               url: "https://www.verifiermondevis.fr/simulateur-valorisation-travaux" }
  ]}
>
  <div class="min-h-screen flex flex-col">
    <AstroHeader />

    <main class="flex-1">

      <!-- ‚ïê‚ïê HERO ‚ïê‚ïê -->
      <section class="bg-gradient-to-b from-slate-900 to-slate-800 text-white py-12 sm:py-16">
        <div class="container max-w-2xl text-center">
          <a href="/valorisation-travaux-immobiliers"
             class="inline-flex items-center gap-1.5 text-slate-400 hover:text-white mb-5 transition-colors text-xs">
            <svg xmlns="http://www.w3.org/2000/svg" class="h-3.5 w-3.5" fill="none" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor">
              <path stroke-linecap="round" stroke-linejoin="round" d="M10.5 19.5L3 12m0 0l7.5-7.5M3 12h18" />
            </svg>
            Guide valorisation des travaux
          </a>
          <h1 class="text-3xl sm:text-4xl font-bold leading-tight mb-3">
            Simulateur de valorisation<br class="hidden sm:block" /> des travaux immobiliers
          </h1>
          <p class="text-slate-300 text-base sm:text-lg leading-relaxed max-w-lg mx-auto">
            Renseignez vos postes de travaux pour estimer la revalorisation globale de votre bien,
            le risque de surcapitalisation et l'impact locatif.
          </p>
        </div>
      </section>

      <!-- ‚ïê‚ïê SIMULATEUR ‚ïê‚ïê -->
      <section class="py-10 sm:py-14 bg-slate-50">
        <div class="container max-w-2xl">

          <!-- ‚îÄ‚îÄ FORMULAIRE ‚îÄ‚îÄ -->
          <div class="bg-white rounded-2xl border border-slate-200 shadow-sm p-6 sm:p-8 mb-6">

            <p class="text-[11px] font-bold uppercase tracking-widest text-slate-400 mb-4">
              Contexte du bien
            </p>

            <!-- Ligne 1 : valeur + objectif -->
            <div class="grid sm:grid-cols-2 gap-4 mb-4">
              <div>
                <label for="property-value" class="block text-sm font-semibold text-slate-700 mb-1.5">
                  Valeur estim√©e du bien (‚Ç¨)
                  <span class="text-xs font-normal text-slate-400 ml-1">‚Äî recommand√©</span>
                </label>
                <div class="relative">
                  <input id="property-value" type="number" min="0" step="5000" placeholder="Ex. 220 000"
                    class="w-full rounded-xl border border-slate-200 bg-slate-50 px-4 py-2.5 pr-10 text-slate-900 text-sm font-medium placeholder:text-slate-400 focus:outline-none focus:ring-2 focus:ring-primary/30 focus:border-primary transition-colors" />
                  <span class="absolute right-3 top-1/2 -translate-y-1/2 text-slate-400 text-xs pointer-events-none">‚Ç¨</span>
                </div>
              </div>
              <div>
                <p class="block text-sm font-semibold text-slate-700 mb-1.5">Objectif</p>
                <div class="flex gap-2">
                  <button id="btn-revente" type="button"
                    class="flex-1 flex items-center justify-center gap-2 rounded-xl border-2 border-primary bg-primary/5 px-3 py-2.5 text-sm font-semibold text-primary transition-all">
                    <span>üè†</span><span>Revente</span>
                  </button>
                  <button id="btn-location" type="button"
                    class="flex-1 flex items-center justify-center gap-2 rounded-xl border-2 border-slate-200 bg-slate-50 px-3 py-2.5 text-sm font-semibold text-slate-500 transition-all hover:border-slate-300">
                    <span>üîë</span><span>Location</span>
                  </button>
                </div>
              </div>
            </div>

            <!-- Ligne 2 : surface + type de bien -->
            <div class="grid sm:grid-cols-2 gap-3 mb-3">
              <div>
                <label for="property-surface" class="block text-sm font-semibold text-slate-700 mb-1.5">
                  Surface actuelle (m¬≤)
                  <span class="text-xs font-normal text-slate-400 ml-1">‚Äî optionnel</span>
                </label>
                <div class="relative">
                  <input id="property-surface" type="number" min="0" step="5" placeholder="Ex. 75"
                    class="w-full rounded-xl border border-slate-200 bg-slate-50 px-3 py-2.5 pr-9 text-slate-900 text-sm font-medium placeholder:text-slate-400 focus:outline-none focus:ring-2 focus:ring-primary/30 focus:border-primary transition-colors" />
                  <span class="absolute right-2.5 top-1/2 -translate-y-1/2 text-slate-400 text-xs pointer-events-none">m¬≤</span>
                </div>
              </div>
              <div>
                <label for="property-type" class="block text-sm font-semibold text-slate-700 mb-1.5">
                  Type de bien
                </label>
                <div class="relative">
                  <select id="property-type"
                    class="w-full appearance-none rounded-xl border border-slate-200 bg-slate-50 pl-3 pr-8 py-2.5 text-slate-900 text-sm focus:outline-none focus:ring-2 focus:ring-primary/30 focus:border-primary transition-colors cursor-pointer">
                    <option value="">Non pr√©cis√©</option>
                    <option value="appartement">Appartement</option>
                    <option value="maison">Maison</option>
                  </select>
                  <svg class="absolute right-2.5 top-1/2 -translate-y-1/2 h-3.5 w-3.5 text-slate-400 pointer-events-none" fill="none" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor">
                    <path stroke-linecap="round" stroke-linejoin="round" d="M19.5 8.25l-7.5 7.5-7.5-7.5"/>
                  </svg>
                </div>
              </div>
            </div>

            <!-- Ligne 3 : code postal + commune -->
            <div class="grid sm:grid-cols-2 gap-3 mb-1.5">
              <div>
                <label for="property-zip" class="block text-sm font-semibold text-slate-700 mb-1.5">
                  Code postal
                  <span class="text-xs font-normal text-slate-400 ml-1">‚Äî DVF</span>
                </label>
                <input id="property-zip" type="text" maxlength="5" placeholder="Ex. 33000"
                  class="w-full rounded-xl border border-slate-200 bg-slate-50 px-3 py-2.5 text-slate-900 text-sm font-medium placeholder:text-slate-400 focus:outline-none focus:ring-2 focus:ring-primary/30 focus:border-primary transition-colors" />
              </div>
              <div>
                <label for="commune-select" class="block text-sm font-semibold text-slate-700 mb-1.5">
                  Commune (DVF)
                  <span id="commune-loading-label" class="hidden text-xs font-normal text-slate-400 ml-1">‚Äî chargement‚Ä¶</span>
                </label>
                <div class="relative">
                  <select id="commune-select" disabled
                    class="w-full appearance-none rounded-xl border border-slate-200 bg-slate-50 pl-3 pr-8 py-2.5 text-slate-900 text-sm disabled:opacity-50 disabled:cursor-not-allowed focus:outline-none focus:ring-2 focus:ring-primary/30 focus:border-primary transition-colors cursor-pointer">
                    <option value="">‚Äî entrez un code postal ‚Äî</option>
                  </select>
                  <svg class="absolute right-2.5 top-1/2 -translate-y-1/2 h-3.5 w-3.5 text-slate-400 pointer-events-none" fill="none" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor">
                    <path stroke-linecap="round" stroke-linejoin="round" d="M19.5 8.25l-7.5 7.5-7.5-7.5"/>
                  </svg>
                </div>
              </div>
            </div>

            <!-- Multi-commune info -->
            <div id="communes-multi-info" class="hidden mb-1.5 flex items-start gap-1.5 text-xs text-blue-700 bg-blue-50 border border-blue-200 rounded-lg px-3 py-2">
              <svg class="h-3.5 w-3.5 flex-shrink-0 mt-0.5" fill="none" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor">
                <circle cx="12" cy="12" r="10"/><path d="M12 16v-4m0-4h.01"/>
              </svg>
              <span>Plusieurs communes correspondent √† ce code postal ‚Äî choisissez celle de votre bien.</span>
            </div>

            <!-- DVF statut (sous la commune) -->
            <div id="dvf-loading" class="hidden mb-3 flex items-center gap-1.5 text-xs text-slate-400">
              <svg class="h-3 w-3 animate-spin" fill="none" viewBox="0 0 24 24">
                <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"/>
                <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4z"/>
              </svg>
              Chargement des donn√©es DVF‚Ä¶
            </div>
            <div id="dvf-status-loaded" class="hidden mb-3 flex items-center gap-1.5 text-xs text-emerald-700 bg-emerald-50 border border-emerald-200 rounded-lg px-3 py-2">
              <svg class="h-3.5 w-3.5 flex-shrink-0" fill="none" viewBox="0 0 24 24" stroke-width="2.5" stroke="currentColor">
                <path stroke-linecap="round" stroke-linejoin="round" d="M4.5 12.75l6 6 9-13.5"/>
              </svg>
              <span id="dvf-status-text"></span>
            </div>
            <div id="dvf-status-unavailable" class="hidden mb-3 text-xs text-slate-400 italic px-0.5">
              <span id="dvf-unavail-text">Donn√©es DVF indisponibles pour cette commune.</span>
            </div>

            <!-- mb s√©parateur DVF / loyer -->
            <div class="mb-3"></div>

            <!-- Loyer actuel (Location uniquement) -->
            <div id="rent-field" class="hidden mb-4">
              <label for="current-rent" class="block text-sm font-semibold text-slate-700 mb-1.5">
                Loyer actuel (‚Ç¨/mois)
                <span class="text-xs font-normal text-slate-400 ml-1">‚Äî requis pour l'analyse locative</span>
              </label>
              <div class="relative max-w-xs">
                <input id="current-rent" type="number" min="0" step="50" placeholder="Ex. 800"
                  class="w-full rounded-xl border border-slate-200 bg-slate-50 px-4 py-2.5 pr-16 text-slate-900 text-sm font-medium placeholder:text-slate-400 focus:outline-none focus:ring-2 focus:ring-primary/30 focus:border-primary transition-colors" />
                <span class="absolute right-3 top-1/2 -translate-y-1/2 text-slate-400 text-xs pointer-events-none">‚Ç¨/mois</span>
              </div>
            </div>

            <!-- S√©parateur -->
            <div class="border-t border-slate-100 mb-5"></div>

            <p class="text-[11px] font-bold uppercase tracking-widest text-slate-400 mb-3">
              Postes de travaux
            </p>

            <div class="hidden sm:grid sm:grid-cols-[1fr_9rem_2.25rem] gap-2 mb-1.5 px-0.5">
              <p class="text-xs text-slate-400">Type de travaux</p>
              <p class="text-xs text-slate-400">Budget (‚Ç¨)</p>
              <p></p>
            </div>

            <div id="work-items-container" class="space-y-1 mb-3"></div>

            <button id="add-row-btn" type="button"
              class="flex items-center gap-1.5 text-sm font-medium text-primary hover:text-primary/80 transition-colors py-1 mb-5">
              <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" fill="none" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor">
                <path stroke-linecap="round" stroke-linejoin="round" d="M12 4.5v15m7.5-7.5h-15" />
              </svg>
              Ajouter un poste
            </button>

            <p id="form-error" class="hidden mb-4 text-sm text-red-600 bg-red-50 border border-red-200 rounded-lg px-4 py-2.5">
              <span id="form-error-text">Ajoutez au moins un poste de travaux avec un budget.</span>
            </p>

            <button id="btn-estimate" type="button"
              class="w-full flex items-center justify-center gap-2 bg-slate-900 text-white hover:bg-slate-800 font-semibold rounded-xl px-6 py-3 text-sm transition-colors disabled:opacity-60 disabled:cursor-not-allowed">
              <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" fill="none" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor">
                <path stroke-linecap="round" stroke-linejoin="round" d="M9 7h6m0 10v-3m-3 3h.01M9 17h.01M9 11h.01M12 11h.01M15 11h.01M4.5 19.5l1.5-1.5M19.5 19.5l-1.5-1.5M4.5 4.5l1.5 1.5M19.5 4.5l-1.5 1.5M12 3v1.5M12 19.5V21M3 12h1.5M19.5 12H21" />
              </svg>
              <span id="btn-estimate-label">Analyser le projet</span>
            </button>

          </div>

          <!-- ‚îÄ‚îÄ R√âSULTAT ‚îÄ‚îÄ -->
          <div id="result" class="hidden bg-white rounded-2xl border border-slate-200 shadow-sm overflow-hidden"
               aria-live="polite" aria-atomic="true">

            <!-- ‚îÄ‚îÄ Synth√®se ‚îÄ‚îÄ -->
            <div class="p-6 sm:p-8">

              <p class="text-[11px] font-bold uppercase tracking-widest text-slate-400 mb-4">
                Synth√®se financi√®re
              </p>

              <!-- Bloc Synth√®se locative (Location seulement) -->
              <div id="r-location-summary" class="hidden mb-5 rounded-xl bg-emerald-50 border border-emerald-200 p-4">
                <p class="text-[10px] font-bold uppercase tracking-widest text-emerald-600 mb-3">Synth√®se locative</p>
                <div class="grid grid-cols-3 gap-2 text-center">
                  <div class="bg-white rounded-lg p-2.5 border border-emerald-100">
                    <p id="r-ls-surplus-m" class="text-sm sm:text-base font-bold text-slate-900">‚Äî</p>
                    <p class="text-[11px] text-slate-500 mt-0.5">Surplus/mois</p>
                  </div>
                  <div class="bg-white rounded-lg p-2.5 border border-emerald-100">
                    <p id="r-ls-surplus-a" class="text-sm sm:text-base font-bold text-slate-900">‚Äî</p>
                    <p class="text-[11px] text-slate-500 mt-0.5">Surplus/an</p>
                  </div>
                  <div class="bg-white rounded-lg p-2.5 border border-emerald-100">
                    <p id="r-ls-payback" class="text-sm sm:text-base font-bold text-slate-900">‚Äî</p>
                    <p class="text-[11px] text-slate-500 mt-0.5">Amortissement</p>
                  </div>
                </div>
              </div>

              <!-- Lignes synth√®se -->
              <div>
                <!-- Budget total (toujours visible) -->
                <div class="flex items-center justify-between py-3 gap-4 border-b border-slate-100">
                  <span class="text-sm text-slate-600">Budget total travaux</span>
                  <span id="r-budget-total" class="text-sm font-bold tabular-nums font-mono text-slate-900"></span>
                </div>

                <!-- Rows Revente uniquement ‚Äî masqu√©es en Location -->
                <div id="r-revente-rows">
                  <div class="flex items-center justify-between py-3 gap-4 border-b border-slate-100">
                    <span class="text-sm text-slate-600">Revalorisation estim√©e</span>
                    <div class="flex items-baseline gap-2 flex-shrink-0">
                      <span id="r-delta-value" class="text-sm font-bold tabular-nums font-mono text-slate-900"></span>
                      <span id="r-recovery-pct" class="text-xs text-slate-400"></span>
                    </div>
                  </div>
                  <div id="r-new-value-row" class="hidden flex items-center justify-between py-3 gap-4 border-b border-slate-100">
                    <span class="text-sm text-slate-600">Valeur estim√©e apr√®s travaux</span>
                    <span id="r-new-value" class="text-sm font-bold tabular-nums font-mono text-slate-900"></span>
                  </div>
                </div>

                <!-- Nature dominante (toujours visible) -->
                <div class="flex items-center justify-between py-3 gap-4">
                  <span class="text-sm text-slate-600">Nature dominante du projet</span>
                  <span id="r-dominant" class="text-sm font-medium text-slate-700 text-right max-w-[55%]"></span>
                </div>
              </div>

              <!-- Accord√©on patrimonial (Location seulement) -->
              <details id="r-patrimoine-accord" class="hidden group mt-3 border border-slate-100 rounded-xl overflow-hidden">
                <summary class="flex items-center gap-1.5 px-4 py-2.5 text-xs font-medium text-slate-500 hover:text-slate-700 hover:bg-slate-50 cursor-pointer select-none list-none transition-colors">
                  <svg class="h-3.5 w-3.5 text-slate-400 transition-transform group-open:rotate-90" fill="none" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor">
                    <path stroke-linecap="round" stroke-linejoin="round" d="M8.25 4.5l7.5 7.5-7.5 7.5"/>
                  </svg>
                  Donn√©es patrimoniales (revente)
                </summary>
                <div class="px-4 pb-3 divide-y divide-slate-100 bg-slate-50/60">
                  <div class="flex justify-between py-2.5 gap-4">
                    <span class="text-sm text-slate-500">Revalorisation estim√©e</span>
                    <div class="flex items-baseline gap-2">
                      <span id="r-accord-delta" class="text-sm font-bold tabular-nums font-mono text-slate-700"></span>
                      <span id="r-accord-pct"   class="text-xs text-slate-400"></span>
                    </div>
                  </div>
                  <div id="r-accord-newval-row" class="hidden flex justify-between py-2.5 gap-4">
                    <span class="text-sm text-slate-500">Valeur apr√®s travaux</span>
                    <span id="r-accord-newval" class="text-sm font-bold tabular-nums font-mono text-slate-700"></span>
                  </div>
                </div>
              </details>

              <!-- Surcapitalisation -->
              <div id="r-overcap" class="hidden mt-4 rounded-lg border p-3.5 text-sm leading-relaxed"></div>

              <!-- DVF encadr√© (r√©sultats) -->
              <div id="r-dvf-box" class="hidden mt-4 rounded-xl border border-blue-200 bg-blue-50 p-4">
                <p class="text-[10px] font-bold uppercase tracking-widest text-blue-500 mb-3">Analyse march√© DVF ‚Äî donn√©es publiques</p>
                <div class="grid grid-cols-[1fr_auto] gap-x-4 gap-y-2 text-sm mb-3">
                  <span class="text-slate-500">Prix moyen march√©</span>
                  <span id="r-dvf-prix-m2" class="font-bold text-slate-900 text-right tabular-nums font-mono"></span>

                  <span id="r-dvf-surface-label" class="text-slate-500">Surface totale</span>
                  <span id="r-dvf-surface-total" class="font-bold text-slate-900 text-right tabular-nums font-mono"></span>

                  <span id="r-dvf-theorique-label" class="text-slate-500">Valeur th√©orique march√©</span>
                  <span id="r-dvf-valeur-theorique" class="font-bold text-slate-900 text-right tabular-nums font-mono"></span>

                  <span id="r-dvf-apres-label" class="text-slate-500">Valeur estim√©e apr√®s travaux</span>
                  <span id="r-dvf-valeur-apres" class="font-bold text-slate-900 text-right tabular-nums font-mono"></span>

                  <span id="r-dvf-ecart-label" class="text-slate-500">√âcart march√©</span>
                  <span id="r-dvf-ecart" class="font-bold text-right tabular-nums font-mono"></span>
                </div>
                <div id="r-dvf-badge" class="inline-flex items-center gap-1.5 px-3 py-1.5 rounded-lg text-sm font-semibold"></div>
                <p class="text-[10px] text-slate-400 mt-2">
                  <span id="r-dvf-commune"></span> ¬∑ <span id="r-dvf-source"></span>
                </p>
              </div>

              <!-- DVF indisponible -->
              <div id="r-dvf-unavailable" class="hidden mt-3 text-xs text-slate-400 italic">
                Donn√©es DVF non disponibles pour cette commune (bient√¥t couvert).
              </div>

            </div>

            <!-- ‚îÄ‚îÄ Impact locatif ‚îÄ‚îÄ -->
            <div id="r-location-section" class="hidden border-t border-slate-200 bg-slate-50 p-6 sm:p-8">

              <p class="text-[11px] font-bold uppercase tracking-widest text-slate-400 mb-4">
                Impact locatif
              </p>

              <!-- Alerte surface manquante -->
              <div id="r-location-surface-warning" class="hidden mb-4 rounded-lg border border-amber-200 bg-amber-50 p-3.5 text-sm text-amber-800 leading-relaxed">
                <strong>Surface ajout√©e manquante.</strong> Votre projet inclut une extension ou un am√©nagement de combles.
                Pour estimer l'impact locatif de la surface cr√©√©e, renseignez le champ&nbsp;¬´&nbsp;Surface cr√©√©e (m¬≤)&nbsp;¬ª sur le poste concern√©.
                Les lignes ci-dessous sont partiellement calcul√©es.
              </div>

              <div class="divide-y divide-slate-200">
                <div class="flex items-center justify-between py-3 gap-4">
                  <span class="text-sm text-slate-600">Rendement brut actuel</span>
                  <span id="r-yield-current" class="text-sm font-bold tabular-nums font-mono text-slate-900"></span>
                </div>
                <div class="flex items-start justify-between py-3 gap-4">
                  <div>
                    <p class="text-sm text-slate-600">Rendement brut apr√®s travaux</p>
                    <p id="r-yield-hypothesis" class="text-xs text-slate-400 italic mt-0.5">Hypoth√®se : taux de capitalisation stable</p>
                  </div>
                  <span id="r-yield-after" class="text-sm font-bold tabular-nums font-mono text-slate-900 flex-shrink-0"></span>
                </div>
                <div class="flex items-center justify-between py-3 gap-4">
                  <span class="text-sm text-slate-600">Loyer estim√© apr√®s travaux</span>
                  <span id="r-new-rent" class="text-sm font-bold tabular-nums font-mono text-slate-900 flex-shrink-0"></span>
                </div>
                <div class="flex items-center justify-between py-3 gap-4">
                  <span class="text-sm text-slate-600">Surplus mensuel</span>
                  <span id="r-delta-rent" class="text-sm font-bold tabular-nums font-mono text-slate-900 flex-shrink-0"></span>
                </div>
                <div class="flex items-center justify-between py-3 gap-4">
                  <span class="text-sm text-slate-600">Surplus annuel</span>
                  <span id="r-delta-rent-annual" class="text-sm font-bold tabular-nums font-mono text-slate-900 flex-shrink-0"></span>
                </div>
                <div class="flex items-center justify-between py-3 gap-4">
                  <span class="text-sm text-slate-600">Amortissement estim√©</span>
                  <span id="r-payback" class="text-sm font-bold tabular-nums font-mono text-slate-900 flex-shrink-0"></span>
                </div>
              </div>

              <div id="r-location-missing" class="hidden mt-4 rounded-lg border border-slate-200 bg-white p-3 text-xs text-slate-500 italic">
                Renseignez le loyer actuel pour calculer l'impact locatif.
              </div>
              <div id="r-location-note" class="hidden mt-3 text-xs text-slate-400 italic leading-relaxed"></div>

            </div>

            <!-- ‚îÄ‚îÄ D√©tail par poste ‚îÄ‚îÄ -->
            <div class="border-t border-slate-200 p-6 sm:p-8">
              <p class="text-[11px] font-bold uppercase tracking-widest text-slate-400 mb-4">D√©tail par poste</p>
              <div class="overflow-x-auto">
                <table class="w-full text-sm">
                  <thead>
                    <tr class="border-b border-slate-200">
                      <th class="text-left pb-2 text-xs font-semibold text-slate-400 uppercase tracking-wider">Travaux</th>
                      <th class="text-right pb-2 text-xs font-semibold text-slate-400 uppercase tracking-wider pr-1">Budget</th>
                      <th class="text-right pb-2 text-xs font-semibold text-slate-400 uppercase tracking-wider">R√©cup. est.</th>
                    </tr>
                  </thead>
                  <tbody id="r-detail-tbody"></tbody>
                  <tfoot>
                    <tr class="border-t-2 border-slate-300">
                      <td class="pt-3 pb-1 text-sm font-bold text-slate-900">Total</td>
                      <td id="r-total-budget" class="pt-3 pb-1 text-right text-sm font-bold tabular-nums font-mono text-slate-900 pr-1"></td>
                      <td id="r-total-delta"  class="pt-3 pb-1 text-right text-sm font-bold tabular-nums font-mono text-slate-900"></td>
                    </tr>
                  </tfoot>
                </table>
              </div>
            </div>

            <!-- ‚îÄ‚îÄ Indice Strat√©gique Immobilier‚Ñ¢ ‚îÄ‚îÄ -->
            <div id="r-strategic-section" class="border-t border-slate-200 p-6 sm:p-8">
              <p class="text-[11px] font-bold uppercase tracking-widest text-slate-400 mb-4">Indice Strat√©gique Immobilier‚Ñ¢</p>
              <SimulateurScoresApp client:only="react" />
            </div>

            <!-- ‚îÄ‚îÄ CTA + mention l√©gale ‚îÄ‚îÄ -->
            <div class="border-t border-slate-200 bg-slate-50 p-6 sm:p-8">
              <a href="/nouvelle-analyse"
                class="w-full flex items-center justify-center gap-2 bg-primary text-primary-foreground hover:bg-primary/90 font-semibold rounded-xl px-6 py-3 text-sm transition-colors mb-4">
                <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4 flex-shrink-0" fill="none" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor">
                  <path stroke-linecap="round" stroke-linejoin="round" d="M3 16.5v2.25A2.25 2.25 0 005.25 21h13.5A2.25 2.25 0 0021 18.75V16.5m-13.5-9L12 3m0 0l4.5 4.5M12 3v13.5" />
                </svg>
                Analyser mon devis pour une estimation bas√©e sur mes prix r√©els
              </a>
              <p class="text-xs text-slate-400 italic leading-relaxed">
                Les taux de r√©cup√©ration sont des ordres de grandeur issus d'observations du march√© immobilier fran√ßais.
                Ils ne constituent pas une estimation professionnelle. Les r√©sultats varient selon la localisation pr√©cise,
                la qualit√© d'ex√©cution, l'√©tat initial du bien et les conditions du march√© local.
              </p>
            </div>

          </div>

        </div>
      </section>

      <!-- ‚ïê‚ïê EXPLICATION ‚ïê‚ïê -->
      <section class="py-10 sm:py-12 border-t border-slate-200">
        <div class="container max-w-2xl">
          <p class="text-[11px] font-bold uppercase tracking-widest text-slate-400 mb-3">M√©thodologie</p>
          <p class="text-sm text-slate-600 leading-relaxed mb-3">
            Chaque poste est √©valu√© via l'<strong>Indice Strat√©gique Immobilier‚Ñ¢</strong> (IVP / IPI) calcul√© depuis
            notre r√©f√©rentiel de plus de 300 types de travaux. Les <strong>donn√©es DVF</strong> (actes notari√©s ‚Äì data.gouv.fr)
            enrichissent le diagnostic de surcapitalisation avec le prix m√©dian r√©el du secteur.
            En mode Location, le mod√®le distingue les travaux cr√©ant de la surface habitable des r√©novations sans surface ajout√©e.
          </p>
          <div class="flex flex-wrap gap-3 text-sm mt-5">
            <a href="/nouvelle-analyse" class="inline-flex items-center gap-1.5 bg-primary text-primary-foreground hover:bg-primary/90 px-4 py-2 rounded-lg font-medium transition-colors">
              Analyser mon devis
            </a>
            <a href="/valorisation-travaux-immobiliers" class="inline-flex items-center gap-1.5 border border-slate-300 text-slate-700 hover:bg-slate-50 px-4 py-2 rounded-lg transition-colors">
              Guide valorisation
            </a>
          </div>
        </div>
      </section>

    </main>
    <AstroFooter />
  </div>
</BaseLayout>

<!-- ‚ïê‚ïê LOGIQUE SIMULATEUR V6 ‚ïê‚ïê -->
<script>
  // ‚îÄ‚îÄ Types ‚îÄ‚îÄ
  type Objective = 'revente' | 'location';

  interface WorkTypeDef { label: string; }

  interface WorkItemData {
    type:         string;
    label:        string;
    budget:       number;
    surfaceAdded: number | null;
  }

  interface CommuneItem {
    nom:      string;
    codeInsee: string;
  }

  interface DvfResult {
    dvf_available: true;
    code_insee:    string;
    commune:       string;
    code_postal?:  string;
    prix_m2:       number;
    source:        string;
  }

  // ‚îÄ‚îÄ R√©f√©rentiel ‚îÄ‚îÄ
  const WORK_TYPES: Record<string, WorkTypeDef> = {
    extension:              { label: "Extension / sur√©l√©vation" },
    combles:                { label: "Am√©nagement des combles" },
    renovation_energetique: { label: "R√©novation √©nerg√©tique globale" },
    isolation:              { label: "Isolation thermique" },
    toiture:                { label: "Toiture / charpente" },
    assainissement:         { label: "Assainissement / plomberie" },
    redistribution:         { label: "Redistribution des espaces" },
    veranda:                { label: "V√©randa / pergola" },
    electricite:            { label: "√âlectricit√© / mise aux normes" },
    photovoltaique:         { label: "Panneaux photovolta√Øques" },
    cuisine:                { label: "Cuisine" },
    salle_bain:             { label: "Salle de bain" },
    terrasse:               { label: "Terrasse / ext√©rieurs" },
    climatisation:          { label: "Climatisation / chauffage" },
    piscine:                { label: "Piscine" },
  };

  const SURFACE_TYPES = new Set(['extension', 'combles']);

  const FALLBACK_RATES: Record<string, number> = {
    extension: 0.85, combles: 0.80, renovation_energetique: 0.80,
    isolation: 0.70, toiture: 0.70, assainissement: 0.70,
    redistribution: 0.60, veranda: 0.60, electricite: 0.60, photovoltaique: 0.60,
    cuisine: 0.50, salle_bain: 0.50, terrasse: 0.50,
    climatisation: 0.40, piscine: 0.40,
  };

  const OPTIONS_HTML: string = Object.entries(WORK_TYPES)
    .map(([k, v]) => `<option value="${k}">${v.label}</option>`)
    .join('');

  // ‚îÄ‚îÄ √âtat ‚îÄ‚îÄ
  let selectedObjective:    Objective   = 'revente';
  let selectedCommune:      CommuneItem | null = null;
  let cachedDvfResult:      DvfResult   | null = null;
  let hasMultipleCommunes:  boolean     = false; // true si plusieurs communes pour ce CP

  // ‚îÄ‚îÄ Formatters ‚îÄ‚îÄ
  function formatEuro(n: number): string {
    return new Intl.NumberFormat('fr-FR', { style: 'currency', currency: 'EUR', maximumFractionDigits: 0 }).format(n);
  }
  function formatPct(n: number, decimals = 1): string {
    return n.toFixed(decimals).replace('.', ',') + '\u202f%';
  }
  function formatPayback(years: number): string {
    if (years >= 30) return '> 30 ans';
    if (years >= 10) return `${Math.round(years)}\u00a0ans`;
    return `${years.toFixed(1).replace('.', ',')}\u00a0ans`;
  }

  // ‚îÄ‚îÄ DOM helpers ‚îÄ‚îÄ
  function el<T extends HTMLElement = HTMLElement>(id: string): T {
    return document.getElementById(id) as T;
  }
  function show(id: string): void { el(id)?.classList.remove('hidden'); }
  function hide(id: string): void { el(id)?.classList.add('hidden');    }

  // ‚îÄ‚îÄ Lignes de travaux ‚îÄ‚îÄ
  function addRow(): void {
    const container = el('work-items-container');
    const div = document.createElement('div');
    div.className = 'work-item-row pb-2 mb-1';

    div.innerHTML = `
      <div class="grid grid-cols-[1fr_7.5rem_2.25rem] sm:grid-cols-[1fr_9rem_2.25rem] gap-2 items-center">
        <div class="relative min-w-0">
          <select class="work-type-select w-full appearance-none rounded-lg border border-slate-200 bg-slate-50 pl-3 pr-7 py-2.5 text-slate-900 text-sm focus:outline-none focus:ring-2 focus:ring-primary/30 focus:border-primary transition-colors cursor-pointer">
            <option value="">Type de travaux‚Ä¶</option>
            ${OPTIONS_HTML}
          </select>
          <svg class="absolute right-2 top-1/2 -translate-y-1/2 h-3.5 w-3.5 text-slate-400 pointer-events-none" fill="none" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor">
            <path stroke-linecap="round" stroke-linejoin="round" d="M19.5 8.25l-7.5 7.5-7.5-7.5"/>
          </svg>
        </div>
        <div class="relative">
          <input type="number" min="0" step="500" placeholder="0"
            class="budget-input w-full rounded-lg border border-slate-200 bg-slate-50 px-3 py-2.5 pr-6 text-slate-900 text-sm tabular-nums focus:outline-none focus:ring-2 focus:ring-primary/30 focus:border-primary transition-colors" />
          <span class="absolute right-2.5 top-1/2 -translate-y-1/2 text-slate-400 text-xs pointer-events-none">‚Ç¨</span>
        </div>
        <button type="button"
          class="delete-row-btn flex items-center justify-center h-9 w-9 rounded-lg text-slate-300 hover:text-red-500 hover:bg-red-50 transition-colors" aria-label="Supprimer">
          <svg class="h-4 w-4" fill="none" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor">
            <path stroke-linecap="round" stroke-linejoin="round" d="M6 18L18 6M6 6l12 12"/>
          </svg>
        </button>
      </div>
      <div class="surface-extra hidden mt-1.5 ml-1 flex items-center gap-2 flex-wrap">
        <label class="text-xs text-amber-700 font-medium flex-shrink-0">Surface cr√©√©e (m¬≤) :</label>
        <div class="relative">
          <input type="number" min="1" step="1" placeholder="Ex. 25"
            class="surface-input w-28 rounded-lg border border-amber-300 bg-amber-50/70 px-3 py-1.5 pr-9 text-slate-900 text-sm focus:outline-none focus:ring-2 focus:ring-amber-400/40 focus:border-amber-400 transition-colors" />
          <span class="absolute right-2.5 top-1/2 -translate-y-1/2 text-slate-400 text-xs pointer-events-none">m¬≤</span>
        </div>
        <p class="text-xs text-amber-600 italic">Requis pour l'impact locatif</p>
      </div>
    `;

    const typeSelect   = div.querySelector<HTMLSelectElement>('.work-type-select')!;
    const surfaceExtra = div.querySelector<HTMLElement>('.surface-extra')!;
    typeSelect.addEventListener('change', () => {
      if (SURFACE_TYPES.has(typeSelect.value)) {
        surfaceExtra.classList.remove('hidden');
      } else {
        surfaceExtra.classList.add('hidden');
        const si = surfaceExtra.querySelector<HTMLInputElement>('.surface-input');
        if (si) si.value = '';
      }
    });

    div.querySelector<HTMLButtonElement>('.delete-row-btn')!
       .addEventListener('click', () => deleteRow(div));

    container.appendChild(div);
  }

  function deleteRow(row: HTMLElement): void {
    const container = el('work-items-container');
    const rows = container.querySelectorAll('.work-item-row');
    if (rows.length <= 1) {
      (row.querySelector('.work-type-select') as HTMLSelectElement).value = '';
      (row.querySelector('.budget-input')     as HTMLInputElement).value  = '';
      const se = row.querySelector<HTMLElement>('.surface-extra');
      if (se) se.classList.add('hidden');
    } else {
      container.removeChild(row);
    }
  }

  function getWorkItems(): WorkItemData[] {
    const rows = document.querySelectorAll<HTMLElement>('.work-item-row');
    const items: WorkItemData[] = [];
    rows.forEach(row => {
      const type   = (row.querySelector('.work-type-select') as HTMLSelectElement).value;
      const budget = parseFloat((row.querySelector('.budget-input') as HTMLInputElement).value) || 0;
      if (type && budget > 0 && WORK_TYPES[type]) {
        const si = row.querySelector<HTMLInputElement>('.surface-input');
        const surfaceAdded = SURFACE_TYPES.has(type) && si ? (parseFloat(si.value) || null) : null;
        items.push({ type, label: WORK_TYPES[type].label, budget, surfaceAdded });
      }
    });
    return items;
  }

  // ‚îÄ‚îÄ Toggle objectif ‚îÄ‚îÄ
  function setObjective(obj: Objective): void {
    selectedObjective = obj;
    const btnR = el<HTMLButtonElement>('btn-revente');
    const btnL = el<HTMLButtonElement>('btn-location');
    const active   = ['border-primary', 'bg-primary/5', 'text-primary'];
    const inactive = ['border-slate-200', 'bg-slate-50', 'text-slate-500'];

    if (obj === 'revente') {
      active.forEach(c   => btnR.classList.add(c));
      inactive.forEach(c => btnR.classList.remove(c));
      inactive.forEach(c => btnL.classList.add(c));
      active.forEach(c   => btnL.classList.remove(c));
      hide('rent-field');
    } else {
      active.forEach(c   => btnL.classList.add(c));
      inactive.forEach(c => btnL.classList.remove(c));
      inactive.forEach(c => btnR.classList.add(c));
      active.forEach(c   => btnR.classList.remove(c));
      show('rent-field');
    }
    hide('result');
  }

  // ‚îÄ‚îÄ G√©o : code postal ‚Üí communes ‚îÄ‚îÄ
  async function loadCommunes(cp: string): Promise<void> {
    const communeSel   = el<HTMLSelectElement>('commune-select');
    const loadingLabel = el('commune-loading-label');

    // Reset
    selectedCommune       = null;
    cachedDvfResult       = null;
    hasMultipleCommunes   = false;
    hide('dvf-status-loaded');
    hide('dvf-status-unavailable');
    hide('dvf-loading');
    hide('communes-multi-info');

    if (!/^\d{5}$/.test(cp)) {
      communeSel.innerHTML = '<option value="">‚Äî entrez un code postal ‚Äî</option>';
      communeSel.disabled  = true;
      return;
    }

    loadingLabel?.classList.remove('hidden');
    communeSel.disabled  = true;
    communeSel.innerHTML = '<option value="">Chargement‚Ä¶</option>';

    try {
      const resp = await fetch(`/api/geo-communes?code_postal=${cp}`);
      const data = await resp.json() as { communes: CommuneItem[] };
      const communes = data.communes ?? [];

      if (communes.length === 0) {
        communeSel.innerHTML = '<option value="">Aucune commune trouv√©e</option>';
        communeSel.disabled  = true;
        return;
      }

      // Peupler
      communeSel.innerHTML = communes.length > 1
        ? '<option value="">Choisissez une commune‚Ä¶</option>'
        : '';
      communes.forEach(c => {
        const opt = document.createElement('option');
        opt.value       = c.codeInsee;
        opt.textContent = c.nom;
        communeSel.appendChild(opt);
      });
      communeSel.disabled = false;

      hasMultipleCommunes = communes.length > 1;

      if (communes.length === 1) {
        // Auto-s√©lection
        communeSel.value = communes[0]!.codeInsee;
        selectedCommune  = communes[0]!;
        await fetchDvfForCommune();
      } else {
        show('communes-multi-info');
      }

    } catch {
      communeSel.innerHTML = '<option value="">Erreur de chargement</option>';
      communeSel.disabled  = true;
    } finally {
      loadingLabel?.classList.add('hidden');
    }
  }

  // ‚îÄ‚îÄ DVF : commune ‚Üí prix/m¬≤ (table dvf_prices) ‚îÄ‚îÄ
  async function fetchDvfForCommune(): Promise<void> {
    hide('dvf-status-loaded');
    hide('dvf-status-unavailable');
    cachedDvfResult = null;

    if (!selectedCommune) return;

    show('dvf-loading');

    try {
      const url = `/api/market-prices?code_insee=${selectedCommune.codeInsee}`;
      const resp = await fetch(url);
      if (!resp.ok) throw new Error('HTTP ' + resp.status);

      type DvfApiResp = DvfResult | { dvf_available: false; note?: string };
      const data = await resp.json() as DvfApiResp;

      if (data.dvf_available && 'prix_m2' in data && data.prix_m2) {
        cachedDvfResult = data;
        el('dvf-status-text').textContent =
          `${data.commune} ¬∑ ${data.prix_m2.toLocaleString('fr-FR')}\u00a0‚Ç¨/m¬≤`;
        show('dvf-status-loaded');
      } else {
        el('dvf-unavail-text').textContent =
          ('note' in data && data.note) || 'Donn√©es DVF indisponibles pour cette commune.';
        show('dvf-status-unavailable');
      }

    } catch {
      hide('dvf-status-loaded');
      hide('dvf-status-unavailable');
    } finally {
      hide('dvf-loading');
    }
  }

  // ‚îÄ‚îÄ HTML bouton ‚îÄ‚îÄ
  const BTN_IDLE_HTML = `
    <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4 flex-shrink-0" fill="none" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor">
      <path stroke-linecap="round" stroke-linejoin="round" d="M9 7h6m0 10v-3m-3 3h.01M9 17h.01M9 11h.01M12 11h.01M15 11h.01M4.5 19.5l1.5-1.5M19.5 19.5l-1.5-1.5M4.5 4.5l1.5 1.5M19.5 4.5l-1.5 1.5M12 3v1.5M12 19.5V21M3 12h1.5M19.5 12H21" />
    </svg>
    <span>Analyser le projet</span>
  `;
  const BTN_LOADING_HTML = `
    <svg class="h-4 w-4 animate-spin flex-shrink-0" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
      <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"/>
      <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4z"/>
    </svg>
    <span>Analyse en cours‚Ä¶</span>
  `;

  function dispatchScoreEvent(detail: object): void {
    document.dispatchEvent(new CustomEvent('simulateur-scores-update', { detail }));
  }

  // ‚îÄ‚îÄ Calcul principal ‚îÄ‚îÄ
  async function estimate(): Promise<void> {
    const btn = el<HTMLButtonElement>('btn-estimate');
    const items = getWorkItems();

    if (items.length === 0) {
      el('form-error-text').textContent = 'Ajoutez au moins un poste de travaux avec un budget sup√©rieur √† 0.';
      show('form-error');
      return;
    }

    // Commune obligatoire quand le CP correspond √† plusieurs communes
    if (hasMultipleCommunes && !selectedCommune) {
      el('form-error-text').textContent =
        'S√©lectionnez la commune de votre bien pour acc√©der aux donn√©es DVF march√©. ' +
        '(Effacez le code postal pour continuer sans donn√©es DVF.)';
      show('form-error');
      el<HTMLSelectElement>('commune-select')?.focus();
      return;
    }

    hide('form-error');

    btn.disabled  = true;
    btn.innerHTML = BTN_LOADING_HTML;
    dispatchScoreEvent({ status: 'loading' });

    // ‚îÄ‚îÄ Appel scores strat√©giques (seul appel r√©seau dans estimate) ‚îÄ‚îÄ
    let weightedRate: number | null = null;
    try {
      const resp = await fetch('/api/strategic-scores', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ items: items.map(i => ({ job_type: i.type, amount_ht: i.budget })) }),
      });
      if (resp.ok) {
        const data = await resp.json();
        if (typeof data.weighted_recovery_rate === 'number') weightedRate = data.weighted_recovery_rate;
        dispatchScoreEvent({ status: 'done', scores: data });
      } else {
        dispatchScoreEvent({ status: 'error', error: `HTTP ${resp.status}` });
      }
    } catch {
      dispatchScoreEvent({ status: 'error', error: 'R√©seau indisponible' });
    }

    // Fallback taux
    if (weightedRate === null) {
      const budgetT = items.reduce((s, i) => s + i.budget, 0);
      const wSum    = items.reduce((s, i) => s + (FALLBACK_RATES[i.type] ?? 0.60) * i.budget, 0);
      weightedRate  = budgetT > 0 ? wSum / budgetT : 0.60;
    }

    btn.disabled  = false;
    btn.innerHTML = BTN_IDLE_HTML;

    // DVF pr√©-charg√© lors de la s√©lection commune
    const dvfResult = cachedDvfResult;

    // ‚îÄ‚îÄ Calculs communs ‚îÄ‚îÄ
    const budgetTotal    = items.reduce((s, i) => s + i.budget, 0);
    const deltaTotal     = Math.round(budgetTotal * weightedRate);
    const propertyValue  = parseFloat(el<HTMLInputElement>('property-value').value)   || 0;
    const currentSurface = parseFloat(el<HTMLInputElement>('property-surface').value) || 0;
    const newValue       = propertyValue > 0 ? propertyValue + deltaTotal : 0;
    const dominant       = items.reduce((a, b) => a.budget >= b.budget ? a : b);

    el('r-budget-total').textContent = formatEuro(budgetTotal);
    el('r-dominant').textContent     = dominant.label;

    // ‚îÄ‚îÄ Synth√®se : revente vs location ‚îÄ‚îÄ
    if (selectedObjective === 'revente') {
      show('r-revente-rows');
      hide('r-patrimoine-accord');
      hide('r-location-summary');
      el('r-delta-value').textContent  = `+${formatEuro(deltaTotal)}`;
      el('r-recovery-pct').textContent = `${Math.round(weightedRate * 100)}\u202f% r√©cup√©rables`;
      if (propertyValue > 100_000) {
        el('r-new-value').textContent = formatEuro(newValue);
        show('r-new-value-row');
      } else {
        hide('r-new-value-row');
      }
    } else {
      // Location : masquer revalorisation, proposer accord√©on
      hide('r-revente-rows');
      show('r-patrimoine-accord');
      hide('r-location-summary'); // sera affich√© apr√®s calcul locatif
      el('r-accord-delta').textContent = `+${formatEuro(deltaTotal)}`;
      el('r-accord-pct').textContent   = `${Math.round(weightedRate * 100)}\u202f% r√©cup√©rables`;
      if (propertyValue > 100_000) {
        el('r-accord-newval').textContent = formatEuro(newValue);
        show('r-accord-newval-row');
      } else {
        hide('r-accord-newval-row');
      }
    }

    // ‚îÄ‚îÄ DVF encadr√© + surcapitalisation ‚îÄ‚îÄ
    hide('r-dvf-box');
    hide('r-dvf-unavailable');
    hide('r-overcap');

    if (dvfResult) {
      // Surface totale = surface existante + surface cr√©√©e par les travaux
      const totalSurfaceAdded = items
        .filter(i => SURFACE_TYPES.has(i.type))
        .reduce((s, i) => s + (i.surfaceAdded ?? 0), 0);
      const surfaceTotale = currentSurface + totalSurfaceAdded;

      // Valeur th√©orique march√© = surface totale √ó prix/m¬≤
      const valeurTheorique = surfaceTotale > 0 ? Math.round(surfaceTotale * dvfResult.prix_m2) : null;

      // Valeur estim√©e apr√®s travaux = valeur actuelle + revalorisation
      const prixApres = newValue > 0 ? newValue : null;

      // Remplissage du bloc DVF
      el('r-dvf-prix-m2').textContent = `${dvfResult.prix_m2.toLocaleString('fr-FR')}\u00a0‚Ç¨/m¬≤`;
      el('r-dvf-commune').textContent = dvfResult.commune;
      el('r-dvf-source').textContent  = dvfResult.source;

      if (surfaceTotale > 0) {
        el('r-dvf-surface-total').textContent = `${surfaceTotale}\u00a0m¬≤`;
      } else {
        el('r-dvf-surface-total').textContent = '‚Äî';
      }

      el('r-dvf-valeur-theorique').textContent =
        valeurTheorique !== null ? formatEuro(valeurTheorique) : '‚Äî (surface non renseign√©e)';

      el('r-dvf-valeur-apres').textContent =
        prixApres !== null ? formatEuro(prixApres) : '‚Äî (valeur actuelle non renseign√©e)';

      // √âcart + badge : uniquement si les deux valeurs sont connues
      if (valeurTheorique !== null && prixApres !== null) {
        const delta      = prixApres - valeurTheorique;
        const ratio      = prixApres / valeurTheorique;
        const sign       = delta >= 0 ? '+' : '';
        const deltaColor = delta > 0 ? 'text-red-700' : 'text-emerald-700';
        el('r-dvf-ecart').className = `font-bold text-right tabular-nums font-mono ${deltaColor}`;
        el('r-dvf-ecart').textContent = `${sign}${formatEuro(Math.round(delta))}`;

        const badge = el('r-dvf-badge');
        if (ratio < 0.90) {
          badge.className   = 'inline-flex items-center gap-1.5 px-3 py-1.5 rounded-lg text-sm font-semibold bg-emerald-100 text-emerald-800';
          badge.textContent = 'üü¢ Potentiel de valorisation int√©ressant';
        } else if (ratio <= 1.10) {
          badge.className   = 'inline-flex items-center gap-1.5 px-3 py-1.5 rounded-lg text-sm font-semibold bg-amber-100 text-amber-800';
          badge.textContent = 'üü° Align√© avec le march√©';
        } else {
          badge.className   = 'inline-flex items-center gap-1.5 px-3 py-1.5 rounded-lg text-sm font-semibold bg-red-100 text-red-800';
          badge.textContent = 'üî¥ Risque de surcapitalisation';
        }
      } else {
        el('r-dvf-ecart').textContent = '‚Äî';
        el('r-dvf-badge').textContent = '';
        el('r-dvf-badge').className   = '';
      }

      show('r-dvf-box');

    } else {
      // Pas de DVF ‚Üí fallback ratio budget/valeur
      if (selectedCommune) show('r-dvf-unavailable');
      if (propertyValue > 0) {
        renderOldOvercap(el('r-overcap'), budgetTotal / propertyValue, newValue);
      }
    }

    // ‚îÄ‚îÄ D√©tail par poste ‚îÄ‚îÄ
    el('r-detail-tbody').innerHTML = items.map(item => {
      const delta = Math.round(item.budget * weightedRate!);
      const surfaceTag = (SURFACE_TYPES.has(item.type) && item.surfaceAdded)
        ? `<span class="ml-1 text-xs text-amber-600">(+${item.surfaceAdded}\u00a0m¬≤)</span>` : '';
      return `
        <tr class="border-b border-slate-100 hover:bg-slate-50 transition-colors">
          <td class="py-2.5 pr-2 text-sm text-slate-700">${item.label}${surfaceTag}</td>
          <td class="py-2.5 pr-1 text-right tabular-nums font-mono text-sm text-slate-700 whitespace-nowrap">${formatEuro(item.budget)}</td>
          <td class="py-2.5 text-right tabular-nums font-mono text-sm text-slate-700 whitespace-nowrap">+${formatEuro(delta)}</td>
        </tr>`;
    }).join('');
    el('r-total-budget').textContent = formatEuro(budgetTotal);
    el('r-total-delta').textContent  = `+${formatEuro(deltaTotal)}`;

    // ‚îÄ‚îÄ Impact locatif ‚îÄ‚îÄ
    hide('r-location-section');
    if (selectedObjective === 'location') {
      show('r-location-section');

      const currentRent = parseFloat(el<HTMLInputElement>('current-rent').value) || 0;
      const surfaceItems    = items.filter(i => SURFACE_TYPES.has(i.type));
      const nonSurfaceItems = items.filter(i => !SURFACE_TYPES.has(i.type));
      const hasSurfaceWork  = surfaceItems.length > 0;
      const allSurfaceHaveM2 = surfaceItems.every(i => i.surfaceAdded !== null && (i.surfaceAdded ?? 0) > 0);
      const totalSurfaceAdded = surfaceItems.reduce((s, i) => s + (i.surfaceAdded ?? 0), 0);
      const nonSurfaceBudget  = nonSurfaceItems.reduce((s, i) => s + i.budget, 0);

      hide('r-location-missing');
      hide('r-location-surface-warning');
      hide('r-location-note');
      hide('r-location-summary');

      if (!currentRent) {
        show('r-location-missing');
        ['r-yield-current','r-yield-after','r-new-rent','r-delta-rent','r-delta-rent-annual','r-payback']
          .forEach(id => { el(id).textContent = '‚Äî'; });

      } else if (hasSurfaceWork && !allSurfaceHaveM2) {
        show('r-location-surface-warning');
        const hypoEl = el('r-yield-hypothesis');
        if (hypoEl) hypoEl.textContent = 'Calcul incomplet ‚Äî surface cr√©√©e manquante';
        const yield0 = propertyValue > 0 ? (currentRent * 12) / propertyValue : null;
        el('r-yield-current').textContent = yield0 !== null ? formatPct(yield0 * 100) : '‚Äî';
        el('r-yield-after').textContent   = '‚Äî';
        el('r-new-rent').textContent      = '‚Äî';
        el('r-delta-rent').textContent    = '‚Äî';
        el('r-delta-rent-annual').textContent = '‚Äî';
        el('r-payback').textContent       = '‚Äî';

      } else {
        // Calcul complet
        const hypoEl = el('r-yield-hypothesis');
        let deltaRentSurface    = 0;
        let deltaRentNonSurface = 0;
        const notes: string[]   = [];

        // Composante surface
        if (hasSurfaceWork && totalSurfaceAdded > 0) {
          let loyerM2: number;
          if (currentRent > 0 && currentSurface > 0) {
            loyerM2 = currentRent / currentSurface;
            notes.push(`Extension : loyer au m¬≤ actuel (${(loyerM2).toFixed(1).replace('.', ',')}\u00a0‚Ç¨/m¬≤/mois)`);
          } else if (dvfResult && dvfResult.prix_m2 > 0) {
            loyerM2 = (dvfResult.prix_m2 * 0.05) / 12;
            notes.push(`Extension : loyer estim√© via DVF (5\u202f% rendement brut ¬∑ ${dvfResult.commune})`);
          } else {
            loyerM2 = 10;
            notes.push('Extension : estimation prudente 10\u00a0‚Ç¨/m¬≤/mois');
          }
          deltaRentSurface = loyerM2 * totalSurfaceAdded;
        }

        // Composante non-surface (capitalisation, plafonn√©e +10%)
        if (nonSurfaceBudget > 0 && propertyValue > 0) {
          const nonSurfProportion = nonSurfaceBudget / budgetTotal;
          const nonSurfDelta      = deltaTotal * nonSurfProportion;
          const yield0            = (currentRent * 12) / propertyValue;
          const rentContrib       = (nonSurfDelta * yield0) / 12;
          deltaRentNonSurface     = Math.min(rentContrib, currentRent * 0.10);
          if (hasSurfaceWork) {
            notes.push('R√©novation (hors extension) : capitalisation stable, plafonn√©e √† +10\u202f%');
          } else {
            notes.push('Hypoth√®se : capitalisation stable ¬∑ hausse plafonn√©e √† +10\u202f%');
            if (hypoEl) hypoEl.textContent = 'Capitalisation stable ¬∑ hausse plafonn√©e √† +10\u202f%';
          }
        }
        if (hasSurfaceWork && nonSurfaceBudget > 0 && hypoEl) {
          hypoEl.textContent = 'Extension : loyer/m¬≤ ¬∑ R√©novation : capitalisation stable';
        } else if (hasSurfaceWork && hypoEl) {
          hypoEl.textContent = 'Estimation au loyer/m¬≤';
        }

        const totalDeltaRent = deltaRentSurface + deltaRentNonSurface;
        const newRentTotal   = currentRent + totalDeltaRent;
        const deltaAnnual    = totalDeltaRent * 12;
        const payback        = totalDeltaRent > 0 ? budgetTotal / deltaAnnual : null;
        const yield0         = propertyValue > 0 ? (currentRent * 12) / propertyValue : null;
        const newYield       = (propertyValue + deltaTotal) > 0 ? (newRentTotal * 12) / (propertyValue + deltaTotal) : null;
        const sign           = totalDeltaRent >= 0 ? '+' : '';

        el('r-yield-current').textContent = yield0 !== null ? formatPct(yield0 * 100) : '‚Äî';
        el('r-yield-after').textContent   = newYield !== null ? formatPct(newYield * 100) : '‚Äî';
        el('r-new-rent').textContent      = `${formatEuro(Math.round(newRentTotal))}/mois`;
        el('r-delta-rent').textContent        = `${sign}${formatEuro(Math.round(totalDeltaRent))}/mois`;
        el('r-delta-rent-annual').textContent = `${sign}${formatEuro(Math.round(deltaAnnual))}/an`;
        el('r-payback').textContent           = payback !== null ? formatPayback(payback) : '‚Äî';

        // Synth√®se locative (top of results)
        el('r-ls-surplus-m').textContent = `${sign}${formatEuro(Math.round(totalDeltaRent))}/m`;
        el('r-ls-surplus-a').textContent = `${sign}${formatEuro(Math.round(deltaAnnual))}/an`;
        el('r-ls-payback').textContent   = payback !== null ? formatPayback(payback) : '‚Äî';
        show('r-location-summary');

        if (notes.length > 0) {
          el('r-location-note').textContent = notes.join(' ¬∑ ');
          show('r-location-note');
        }
      }
    }

    // ‚îÄ‚îÄ Afficher r√©sultat ‚îÄ‚îÄ
    const resultEl = el('result');
    resultEl.classList.remove('hidden');
    setTimeout(() => resultEl.scrollIntoView({ behavior: 'smooth', block: 'start' }), 80);
  }

  // ‚îÄ‚îÄ Surcap fallback (sans DVF) ‚îÄ‚îÄ
  function renderOldOvercap(el_: HTMLElement, ratio: number, newValue: number): void {
    if (ratio > 0.25) {
      el_.className = 'mt-4 rounded-lg border border-orange-200 bg-orange-50 p-3.5 text-sm text-orange-800 leading-relaxed';
      el_.innerHTML = `<strong>Risque √©lev√© de surcapitalisation.</strong> Le budget travaux repr√©sente ${Math.round(ratio * 100)}\u202f% de la valeur du bien.${newValue ? ` Comparez la valeur cible (${formatEuro(newValue)}) avec les biens comparables du secteur.` : ''}`;
      show('r-overcap');
    } else if (ratio > 0.15) {
      el_.className = 'mt-4 rounded-lg border border-amber-200 bg-amber-50 p-3.5 text-sm text-amber-800 leading-relaxed';
      el_.innerHTML = `<strong>Attention.</strong> Le budget repr√©sente ${Math.round(ratio * 100)}\u202f% de la valeur du bien.${newValue ? ` V√©rifiez que la valeur cible (${formatEuro(newValue)}) reste coh√©rente avec le plafond de prix de votre secteur.` : ''}`;
      show('r-overcap');
    } else {
      hide('r-overcap');
    }
  }

  // ‚îÄ‚îÄ Init ‚îÄ‚îÄ
  function init(): void {
    addRow();

    el('btn-revente')?.addEventListener('click',  () => setObjective('revente'));
    el('btn-location')?.addEventListener('click', () => setObjective('location'));
    el('add-row-btn')?.addEventListener('click',  addRow);
    el('btn-estimate')?.addEventListener('click', () => { void estimate(); });

    el<HTMLInputElement>('property-value')?.addEventListener('keydown', (e) => {
      if ((e as KeyboardEvent).key === 'Enter') void estimate();
    });

    // Code postal ‚Üí chargement des communes
    el<HTMLInputElement>('property-zip')?.addEventListener('input', (e) => {
      void loadCommunes((e.target as HTMLInputElement).value.trim());
    });

    // S√©lection commune ‚Üí fetch DVF
    el<HTMLSelectElement>('commune-select')?.addEventListener('change', () => {
      const sel  = el<HTMLSelectElement>('commune-select');
      const code = sel.value;
      hide('communes-multi-info');
      if (!code) {
        selectedCommune = null;
        cachedDvfResult = null;
        hide('dvf-status-loaded');
        hide('dvf-status-unavailable');
        return;
      }
      const opt = sel.options[sel.selectedIndex];
      selectedCommune = { nom: opt.text, codeInsee: code };
      void fetchDvfForCommune();
    });

    // Changement de type de bien ‚Üí pas de re-fetch DVF (prix_m2 non diff√©renci√© par type)
  }

  init();
</script>
