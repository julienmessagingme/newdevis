---
import BaseLayout from '@/layouts/BaseLayout.astro';
import AstroHeader from '@/components/astro/Header.astro';
import AstroFooter from '@/components/astro/Footer.astro';
import SimulateurScoresApp from '@/components/app/SimulateurScoresApp';

const jsonLd = {
  "@context": "https://schema.org",
  "@type": "WebApplication",
  "name": "Simulateur de valorisation des travaux immobiliers",
  "description": "Calculez la revalorisation estim√©e de votre bien selon vos postes de travaux, avec analyse du risque de surcapitalisation.",
  "url": "https://verifiermondevis.fr/simulateur-valorisation-travaux",
  "applicationCategory": "UtilitiesApplication",
  "operatingSystem": "Web",
  "offers": { "@type": "Offer", "price": "0", "priceCurrency": "EUR" }
};
---

<BaseLayout
  title="Simulateur de valorisation des travaux immobiliers | VerifierMonDevis.fr"
  description="Estimez la revalorisation de votre bien poste par poste. Calcul multi-travaux, analyse de surcapitalisation, impact locatif. Gratuit, sans inscription."
  canonical="https://verifiermondevis.fr/simulateur-valorisation-travaux"
  ogType="article"
  jsonLd={jsonLd}
  breadcrumbs={[
    { name: "Accueil",                  url: "https://verifiermondevis.fr/" },
    { name: "Valorisation des travaux", url: "https://verifiermondevis.fr/valorisation-travaux-immobiliers" },
    { name: "Simulateur",               url: "https://verifiermondevis.fr/simulateur-valorisation-travaux" }
  ]}
>
  <div class="min-h-screen flex flex-col">
    <AstroHeader />

    <main class="flex-1">

      <!-- ‚ïê‚ïê HERO ‚ïê‚ïê -->
      <section class="bg-gradient-to-b from-slate-900 to-slate-800 text-white py-12 sm:py-16">
        <div class="container max-w-2xl text-center">
          <a
            href="/valorisation-travaux-immobiliers"
            class="inline-flex items-center gap-1.5 text-slate-400 hover:text-white mb-5 transition-colors text-xs"
          >
            <svg xmlns="http://www.w3.org/2000/svg" class="h-3.5 w-3.5" fill="none" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor">
              <path stroke-linecap="round" stroke-linejoin="round" d="M10.5 19.5L3 12m0 0l7.5-7.5M3 12h18" />
            </svg>
            Guide valorisation des travaux
          </a>
          <h1 class="text-3xl sm:text-4xl font-bold leading-tight mb-3">
            Simulateur de valorisation<br class="hidden sm:block" /> des travaux immobiliers
          </h1>
          <p class="text-slate-300 text-base sm:text-lg leading-relaxed max-w-lg mx-auto">
            Renseignez vos postes de travaux pour estimer la revalorisation globale de votre bien,
            le risque de surcapitalisation et l'impact locatif.
          </p>
        </div>
      </section>

      <!-- ‚ïê‚ïê SIMULATEUR ‚ïê‚ïê -->
      <section class="py-10 sm:py-14 bg-slate-50">
        <div class="container max-w-2xl">

          <!-- ‚îÄ‚îÄ FORMULAIRE ‚îÄ‚îÄ -->
          <div class="bg-white rounded-2xl border border-slate-200 shadow-sm p-6 sm:p-8 mb-6">

            <!-- Section : Contexte -->
            <p class="text-[11px] font-bold uppercase tracking-widest text-slate-400 mb-4">
              Contexte du bien
            </p>

            <!-- Ligne 1 : valeur + objectif -->
            <div class="grid sm:grid-cols-2 gap-4 mb-4">

              <!-- Valeur actuelle du bien -->
              <div>
                <label for="property-value" class="block text-sm font-semibold text-slate-700 mb-1.5">
                  Valeur estim√©e du bien (‚Ç¨)
                  <span class="text-xs font-normal text-slate-400 ml-1">‚Äî recommand√©</span>
                </label>
                <div class="relative">
                  <input
                    id="property-value"
                    type="number"
                    min="0"
                    step="5000"
                    placeholder="Ex. 220 000"
                    class="w-full rounded-xl border border-slate-200 bg-slate-50 px-4 py-2.5 pr-10 text-slate-900 text-sm font-medium placeholder:text-slate-400 focus:outline-none focus:ring-2 focus:ring-primary/30 focus:border-primary transition-colors"
                  />
                  <span class="absolute right-3 top-1/2 -translate-y-1/2 text-slate-400 text-xs pointer-events-none">‚Ç¨</span>
                </div>
              </div>

              <!-- Objectif -->
              <div>
                <p class="block text-sm font-semibold text-slate-700 mb-1.5">Objectif</p>
                <div class="flex gap-2">
                  <button
                    id="btn-revente"
                    type="button"
                    class="flex-1 flex items-center justify-center gap-2 rounded-xl border-2 border-primary bg-primary/5 px-3 py-2.5 text-sm font-semibold text-primary transition-all"
                  >
                    <span>üè†</span><span>Revente</span>
                  </button>
                  <button
                    id="btn-location"
                    type="button"
                    class="flex-1 flex items-center justify-center gap-2 rounded-xl border-2 border-slate-200 bg-slate-50 px-3 py-2.5 text-sm font-semibold text-slate-500 transition-all hover:border-slate-300"
                  >
                    <span>üîë</span><span>Location</span>
                  </button>
                </div>
              </div>

            </div>

            <!-- Ligne 2 : surface + code postal + type bien -->
            <div class="grid grid-cols-2 sm:grid-cols-3 gap-3 mb-4">

              <!-- Surface actuelle -->
              <div>
                <label for="property-surface" class="block text-sm font-semibold text-slate-700 mb-1.5">
                  Surface (m¬≤)
                  <span class="text-xs font-normal text-slate-400 ml-1">‚Äî optionnel</span>
                </label>
                <div class="relative">
                  <input
                    id="property-surface"
                    type="number"
                    min="0"
                    step="5"
                    placeholder="Ex. 75"
                    class="w-full rounded-xl border border-slate-200 bg-slate-50 px-3 py-2.5 pr-9 text-slate-900 text-sm font-medium placeholder:text-slate-400 focus:outline-none focus:ring-2 focus:ring-primary/30 focus:border-primary transition-colors"
                  />
                  <span class="absolute right-2.5 top-1/2 -translate-y-1/2 text-slate-400 text-xs pointer-events-none">m¬≤</span>
                </div>
              </div>

              <!-- Code postal -->
              <div>
                <label for="property-zip" class="block text-sm font-semibold text-slate-700 mb-1.5">
                  Code postal
                  <span class="text-xs font-normal text-slate-400 ml-1">‚Äî DVF</span>
                </label>
                <input
                  id="property-zip"
                  type="text"
                  maxlength="5"
                  placeholder="Ex. 75015"
                  class="w-full rounded-xl border border-slate-200 bg-slate-50 px-3 py-2.5 text-slate-900 text-sm font-medium placeholder:text-slate-400 focus:outline-none focus:ring-2 focus:ring-primary/30 focus:border-primary transition-colors"
                />
              </div>

              <!-- Type de bien -->
              <div class="col-span-2 sm:col-span-1">
                <label for="property-type" class="block text-sm font-semibold text-slate-700 mb-1.5">
                  Type de bien
                </label>
                <div class="relative">
                  <select
                    id="property-type"
                    class="w-full appearance-none rounded-xl border border-slate-200 bg-slate-50 pl-3 pr-8 py-2.5 text-slate-900 text-sm focus:outline-none focus:ring-2 focus:ring-primary/30 focus:border-primary transition-colors cursor-pointer"
                  >
                    <option value="">Non pr√©cis√©</option>
                    <option value="appartement">Appartement</option>
                    <option value="maison">Maison</option>
                  </select>
                  <svg class="absolute right-2.5 top-1/2 -translate-y-1/2 h-3.5 w-3.5 text-slate-400 pointer-events-none" fill="none" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor">
                    <path stroke-linecap="round" stroke-linejoin="round" d="M19.5 8.25l-7.5 7.5-7.5-7.5"/>
                  </svg>
                </div>
              </div>

            </div>

            <!-- Loyer actuel (Location uniquement) -->
            <div id="rent-field" class="hidden mb-4">
              <label for="current-rent" class="block text-sm font-semibold text-slate-700 mb-1.5">
                Loyer actuel (‚Ç¨/mois)
                <span class="text-xs font-normal text-slate-400 ml-1">‚Äî requis pour l'analyse locative</span>
              </label>
              <div class="relative max-w-xs">
                <input
                  id="current-rent"
                  type="number"
                  min="0"
                  step="50"
                  placeholder="Ex. 800"
                  class="w-full rounded-xl border border-slate-200 bg-slate-50 px-4 py-2.5 pr-16 text-slate-900 text-sm font-medium placeholder:text-slate-400 focus:outline-none focus:ring-2 focus:ring-primary/30 focus:border-primary transition-colors"
                />
                <span class="absolute right-3 top-1/2 -translate-y-1/2 text-slate-400 text-xs pointer-events-none">‚Ç¨/mois</span>
              </div>
            </div>

            <!-- S√©parateur -->
            <div class="border-t border-slate-100 mb-5"></div>

            <!-- Section : Postes de travaux -->
            <p class="text-[11px] font-bold uppercase tracking-widest text-slate-400 mb-3">
              Postes de travaux
            </p>

            <!-- En-t√™tes colonnes (desktop) -->
            <div class="hidden sm:grid sm:grid-cols-[1fr_9rem_2.25rem] gap-2 mb-1.5 px-0.5">
              <p class="text-xs text-slate-400">Type de travaux</p>
              <p class="text-xs text-slate-400">Budget (‚Ç¨)</p>
              <p></p>
            </div>

            <!-- Lignes dynamiques -->
            <div id="work-items-container" class="space-y-1 mb-3"></div>

            <!-- Ajouter un poste -->
            <button
              id="add-row-btn"
              type="button"
              class="flex items-center gap-1.5 text-sm font-medium text-primary hover:text-primary/80 transition-colors py-1 mb-5"
            >
              <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" fill="none" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor">
                <path stroke-linecap="round" stroke-linejoin="round" d="M12 4.5v15m7.5-7.5h-15" />
              </svg>
              Ajouter un poste
            </button>

            <!-- Message d'erreur -->
            <p id="form-error" class="hidden mb-4 text-sm text-red-600 bg-red-50 border border-red-200 rounded-lg px-4 py-2.5">
              <span id="form-error-text">Ajoutez au moins un poste de travaux avec un budget.</span>
            </p>

            <!-- Submit -->
            <button
              id="btn-estimate"
              type="button"
              class="w-full flex items-center justify-center gap-2 bg-slate-900 text-white hover:bg-slate-800 font-semibold rounded-xl px-6 py-3 text-sm transition-colors disabled:opacity-60 disabled:cursor-not-allowed"
            >
              <svg id="btn-estimate-icon" xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" fill="none" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor">
                <path stroke-linecap="round" stroke-linejoin="round" d="M9 7h6m0 10v-3m-3 3h.01M9 17h.01M9 11h.01M12 11h.01M15 11h.01M4.5 19.5l1.5-1.5M19.5 19.5l-1.5-1.5M4.5 4.5l1.5 1.5M19.5 4.5l-1.5 1.5M12 3v1.5M12 19.5V21M3 12h1.5M19.5 12H21" />
              </svg>
              <span id="btn-estimate-label">Analyser le projet</span>
            </button>

          </div>

          <!-- ‚îÄ‚îÄ R√âSULTAT ‚îÄ‚îÄ -->
          <div
            id="result"
            class="hidden bg-white rounded-2xl border border-slate-200 shadow-sm overflow-hidden"
            aria-live="polite"
            aria-atomic="true"
          >

            <!-- ‚îÄ‚îÄ Synth√®se financi√®re ‚îÄ‚îÄ -->
            <div class="p-6 sm:p-8">

              <p class="text-[11px] font-bold uppercase tracking-widest text-slate-400 mb-4">
                Synth√®se financi√®re
              </p>

              <div class="divide-y divide-slate-100">

                <div class="flex items-center justify-between py-3 gap-4">
                  <span class="text-sm text-slate-600">Budget total travaux</span>
                  <span id="r-budget-total" class="text-sm font-bold tabular-nums font-mono text-slate-900"></span>
                </div>

                <div class="flex items-center justify-between py-3 gap-4">
                  <span class="text-sm text-slate-600">Revalorisation estim√©e</span>
                  <div class="flex items-baseline gap-2 flex-shrink-0">
                    <span id="r-delta-value" class="text-sm font-bold tabular-nums font-mono text-slate-900"></span>
                    <span id="r-recovery-pct" class="text-xs text-slate-400"></span>
                  </div>
                </div>

                <div id="r-new-value-row" class="hidden flex items-center justify-between py-3 gap-4">
                  <span class="text-sm text-slate-600">Valeur estim√©e apr√®s travaux</span>
                  <span id="r-new-value" class="text-sm font-bold tabular-nums font-mono text-slate-900"></span>
                </div>

                <div class="flex items-center justify-between py-3 gap-4">
                  <span class="text-sm text-slate-600">Nature dominante du projet</span>
                  <span id="r-dominant" class="text-sm font-medium text-slate-700 text-right max-w-[55%]"></span>
                </div>

              </div>

              <!-- Surcapitalisation -->
              <div id="r-overcap" class="hidden mt-4 rounded-lg border p-3.5 text-sm leading-relaxed"></div>

              <!-- Encadr√© DVF (prix march√© officiel) -->
              <div id="r-dvf-box" class="hidden mt-4 rounded-xl border border-blue-200 bg-blue-50 p-4">
                <p class="text-[10px] font-bold uppercase tracking-widest text-blue-500 mb-2">Prix march√© officiel ¬∑ ETALAB DVF</p>
                <div class="flex items-end justify-between gap-4 flex-wrap">
                  <div>
                    <p id="r-dvf-price" class="text-2xl font-bold text-slate-900"></p>
                    <p class="text-xs text-slate-500 mt-0.5">
                      <span id="r-dvf-commune"></span> ¬∑
                      <span id="r-dvf-fiabilite"></span> ¬∑
                      <span id="r-dvf-nb"></span> transactions
                    </p>
                  </div>
                  <div id="r-dvf-val-indicative" class="hidden text-right">
                    <p class="text-xs text-slate-500 mb-0.5">Valeur indicative du bien</p>
                    <p id="r-dvf-val-display" class="text-lg font-bold text-slate-800"></p>
                  </div>
                </div>
              </div>

              <!-- Fallback DVF indisponible -->
              <div id="r-dvf-unavailable" class="hidden mt-3 text-xs text-slate-400 italic">
                Donn√©es officielles DVF indisponibles pour ce code postal ‚Äî estimation bas√©e sur notre r√©f√©rentiel interne.
              </div>

            </div>

            <!-- ‚îÄ‚îÄ Impact locatif ‚îÄ‚îÄ -->
            <div id="r-location-section" class="hidden border-t border-slate-200 bg-slate-50 p-6 sm:p-8">

              <p class="text-[11px] font-bold uppercase tracking-widest text-slate-400 mb-4">
                Impact locatif
              </p>

              <!-- Alerte surface manquante pour extension/combles -->
              <div id="r-location-surface-warning" class="hidden mb-4 rounded-lg border border-amber-200 bg-amber-50 p-3.5 text-sm text-amber-800 leading-relaxed">
                <strong>Surface ajout√©e manquante.</strong> Votre projet inclut une extension ou un am√©nagement de combles.
                Pour estimer l'impact locatif de la surface cr√©√©e, renseignez le champ&nbsp;¬´&nbsp;Surface cr√©√©e (m¬≤)&nbsp;¬ª sur le poste concern√©.
                Les lignes ci-dessous sont partiellement calcul√©es.
              </div>

              <div class="divide-y divide-slate-200">

                <div class="flex items-center justify-between py-3 gap-4">
                  <span class="text-sm text-slate-600">Rendement brut actuel</span>
                  <span id="r-yield-current" class="text-sm font-bold tabular-nums font-mono text-slate-900"></span>
                </div>

                <div class="flex items-start justify-between py-3 gap-4">
                  <div>
                    <p class="text-sm text-slate-600">Rendement brut apr√®s travaux</p>
                    <p id="r-yield-hypothesis" class="text-xs text-slate-400 italic mt-0.5">Hypoth√®se : taux de capitalisation stable</p>
                  </div>
                  <span id="r-yield-after" class="text-sm font-bold tabular-nums font-mono text-slate-900 flex-shrink-0"></span>
                </div>

                <div id="r-new-rent-row" class="flex items-center justify-between py-3 gap-4">
                  <span class="text-sm text-slate-600">Loyer estim√© apr√®s travaux</span>
                  <span id="r-new-rent" class="text-sm font-bold tabular-nums font-mono text-slate-900 flex-shrink-0"></span>
                </div>

                <div id="r-delta-rent-row" class="flex items-center justify-between py-3 gap-4">
                  <span class="text-sm text-slate-600">Surplus mensuel</span>
                  <span id="r-delta-rent" class="text-sm font-bold tabular-nums font-mono text-slate-900 flex-shrink-0"></span>
                </div>

                <div class="flex items-center justify-between py-3 gap-4">
                  <span class="text-sm text-slate-600">Surplus annuel</span>
                  <span id="r-delta-rent-annual" class="text-sm font-bold tabular-nums font-mono text-slate-900 flex-shrink-0"></span>
                </div>

                <div class="flex items-center justify-between py-3 gap-4">
                  <span class="text-sm text-slate-600">Amortissement estim√©</span>
                  <span id="r-payback" class="text-sm font-bold tabular-nums font-mono text-slate-900 flex-shrink-0"></span>
                </div>

              </div>

              <!-- Alerte donn√©es manquantes (loyer non renseign√©) -->
              <div id="r-location-missing" class="hidden mt-4 rounded-lg border border-slate-200 bg-white p-3 text-xs text-slate-500 italic">
                Renseignez le loyer actuel pour calculer l'impact locatif.
              </div>

              <!-- Note m√©thodologique -->
              <div id="r-location-note" class="hidden mt-3 text-xs text-slate-400 italic leading-relaxed"></div>

            </div>

            <!-- ‚îÄ‚îÄ D√©tail par poste ‚îÄ‚îÄ -->
            <div class="border-t border-slate-200 p-6 sm:p-8">

              <p class="text-[11px] font-bold uppercase tracking-widest text-slate-400 mb-4">
                D√©tail par poste
              </p>

              <div class="overflow-x-auto">
                <table class="w-full text-sm">
                  <thead>
                    <tr class="border-b border-slate-200">
                      <th class="text-left pb-2 text-xs font-semibold text-slate-400 uppercase tracking-wider">Travaux</th>
                      <th class="text-right pb-2 text-xs font-semibold text-slate-400 uppercase tracking-wider pr-1">Budget</th>
                      <th class="text-right pb-2 text-xs font-semibold text-slate-400 uppercase tracking-wider">R√©cup. est.</th>
                    </tr>
                  </thead>
                  <tbody id="r-detail-tbody">
                    <!-- filled by JS -->
                  </tbody>
                  <tfoot>
                    <tr class="border-t-2 border-slate-300">
                      <td class="pt-3 pb-1 text-sm font-bold text-slate-900">Total</td>
                      <td id="r-total-budget" class="pt-3 pb-1 text-right text-sm font-bold tabular-nums font-mono text-slate-900 pr-1"></td>
                      <td id="r-total-delta"  class="pt-3 pb-1 text-right text-sm font-bold tabular-nums font-mono text-slate-900"></td>
                    </tr>
                  </tfoot>
                </table>
              </div>

            </div>

            <!-- ‚îÄ‚îÄ Indice Strat√©gique Immobilier‚Ñ¢ (island React) ‚îÄ‚îÄ -->
            <div id="r-strategic-section" class="border-t border-slate-200 p-6 sm:p-8">
              <p class="text-[11px] font-bold uppercase tracking-widest text-slate-400 mb-4">
                Indice Strat√©gique Immobilier‚Ñ¢
              </p>
              <SimulateurScoresApp client:only="react" />
            </div>

            <!-- ‚îÄ‚îÄ CTA + mention l√©gale ‚îÄ‚îÄ -->
            <div class="border-t border-slate-200 bg-slate-50 p-6 sm:p-8">

              <a
                href="/nouvelle-analyse"
                class="w-full flex items-center justify-center gap-2 bg-primary text-primary-foreground hover:bg-primary/90 font-semibold rounded-xl px-6 py-3 text-sm transition-colors mb-4"
              >
                <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4 flex-shrink-0" fill="none" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor">
                  <path stroke-linecap="round" stroke-linejoin="round" d="M3 16.5v2.25A2.25 2.25 0 005.25 21h13.5A2.25 2.25 0 0021 18.75V16.5m-13.5-9L12 3m0 0l4.5 4.5M12 3v13.5" />
                </svg>
                Analyser mon devis pour une estimation bas√©e sur mes prix r√©els
              </a>

              <p class="text-xs text-slate-400 italic leading-relaxed">
                Les taux de r√©cup√©ration sont des ordres de grandeur issus d'observations du march√© immobilier fran√ßais.
                Ils ne constituent pas une estimation professionnelle. Les r√©sultats varient selon la localisation pr√©cise,
                la qualit√© d'ex√©cution, l'√©tat initial du bien et les conditions du march√© local au moment de la vente ou de la mise en location.
              </p>

            </div>

          </div>

        </div>
      </section>

      <!-- ‚ïê‚ïê EXPLICATION ‚ïê‚ïê -->
      <section class="py-10 sm:py-12 border-t border-slate-200">
        <div class="container max-w-2xl">
          <p class="text-[11px] font-bold uppercase tracking-widest text-slate-400 mb-3">M√©thodologie</p>
          <p class="text-sm text-slate-600 leading-relaxed mb-3">
            Chaque poste est √©valu√© via l'<strong>Indice Strat√©gique Immobilier‚Ñ¢</strong> (IVP / IPI) calcul√© depuis
            notre r√©f√©rentiel de plus de 300 types de travaux. Le <strong>taux de r√©cup√©ration pond√©r√©</strong>
            retourn√© par l'analyse est appliqu√© uniform√©ment au budget de chaque poste.
            En mode Location, le mod√®le distingue les travaux cr√©ant de la surface habitable
            (extension, combles) des r√©novations sans surface ajout√©e.
          </p>
          <p class="text-sm text-slate-600 leading-relaxed mb-3">
            Les <strong>prix de march√© officiels</strong> (ETALAB DVF) sont r√©cup√©r√©s en temps r√©el
            √† partir des actes notari√©s publi√©s, pour renforcer le diagnostic de surcapitalisation.
          </p>
          <p class="text-sm text-slate-600 leading-relaxed">
            Pour une estimation bas√©e sur les postes exacts de votre devis et les prix du march√© dans votre secteur,
            utilisez l'analyse compl√®te.
          </p>
          <div class="flex flex-wrap gap-3 text-sm mt-5">
            <a href="/nouvelle-analyse" class="inline-flex items-center gap-1.5 bg-primary text-primary-foreground hover:bg-primary/90 px-4 py-2 rounded-lg font-medium transition-colors">
              Analyser mon devis
            </a>
            <a href="/valorisation-travaux-immobiliers" class="inline-flex items-center gap-1.5 border border-slate-300 text-slate-700 hover:bg-slate-50 px-4 py-2 rounded-lg transition-colors">
              Guide valorisation
            </a>
          </div>
        </div>
      </section>

    </main>

    <AstroFooter />
  </div>
</BaseLayout>

<!-- ‚ïê‚ïê LOGIQUE SIMULATEUR V5 ‚ïê‚ïê -->
<script>
  // ‚îÄ‚îÄ Types ‚îÄ‚îÄ
  type Objective = 'revente' | 'location';

  interface WorkTypeDef { label: string; }

  interface WorkItemData {
    type:         string;
    label:        string;
    budget:       number;
    surfaceAdded: number | null; // m¬≤ ajout√©s ‚Äî uniquement pour SURFACE_TYPES
  }

  interface DvfResult {
    available:        true;
    prix_m2_estime:   number;
    source:           string;
    niveau_fiabilite: 'bon' | 'moyen' | 'faible';
    nb_transactions:  number;
    commune:          string;
    type_bien:        string;
  }

  // ‚îÄ‚îÄ R√©f√©rentiel ‚îÄ‚îÄ
  const WORK_TYPES: Record<string, WorkTypeDef> = {
    extension:              { label: "Extension / sur√©l√©vation" },
    combles:                { label: "Am√©nagement des combles" },
    renovation_energetique: { label: "R√©novation √©nerg√©tique globale" },
    isolation:              { label: "Isolation thermique" },
    toiture:                { label: "Toiture / charpente" },
    assainissement:         { label: "Assainissement / plomberie" },
    redistribution:         { label: "Redistribution des espaces" },
    veranda:                { label: "V√©randa / pergola" },
    electricite:            { label: "√âlectricit√© / mise aux normes" },
    photovoltaique:         { label: "Panneaux photovolta√Øques" },
    cuisine:                { label: "Cuisine" },
    salle_bain:             { label: "Salle de bain" },
    terrasse:               { label: "Terrasse / ext√©rieurs" },
    climatisation:          { label: "Climatisation / chauffage" },
    piscine:                { label: "Piscine" },
  };

  // Types cr√©ant de la surface habitable ‚Üí loyer calcul√© en ‚Ç¨/m¬≤
  const SURFACE_TYPES = new Set(['extension', 'combles']);

  // Taux de r√©cup√©ration de repli (si API indisponible)
  const FALLBACK_RATES: Record<string, number> = {
    extension: 0.85, combles: 0.80, renovation_energetique: 0.80,
    isolation: 0.70, toiture: 0.70, assainissement: 0.70,
    redistribution: 0.60, veranda: 0.60, electricite: 0.60, photovoltaique: 0.60,
    cuisine: 0.50, salle_bain: 0.50, terrasse: 0.50,
    climatisation: 0.40, piscine: 0.40,
  };

  // Options HTML pour les selects (g√©n√©r√© une seule fois)
  const OPTIONS_HTML: string = Object.entries(WORK_TYPES)
    .map(([k, v]) => `<option value="${k}">${v.label}</option>`)
    .join('');

  // ‚îÄ‚îÄ Utilitaires ‚îÄ‚îÄ
  function formatEuro(n: number): string {
    return new Intl.NumberFormat('fr-FR', {
      style: 'currency', currency: 'EUR', maximumFractionDigits: 0,
    }).format(n);
  }

  function formatPct(n: number, decimals = 1): string {
    return n.toFixed(decimals).replace('.', ',') + '\u202f%';
  }

  function formatPayback(years: number): string {
    if (years >= 30) return '> 30 ans';
    if (years >= 10) return `${Math.round(years)}\u00a0ans`;
    return `${years.toFixed(1).replace('.', ',')}\u00a0ans`;
  }

  function el<T extends HTMLElement = HTMLElement>(id: string): T {
    return document.getElementById(id) as T;
  }

  function show(id: string): void { el(id)?.classList.remove('hidden'); }
  function hide(id: string): void { el(id)?.classList.add('hidden');    }

  // ‚îÄ‚îÄ √âtat ‚îÄ‚îÄ
  let selectedObjective: Objective = 'revente';

  // ‚îÄ‚îÄ Gestion des lignes de travaux ‚îÄ‚îÄ
  function addRow(): void {
    const container = el('work-items-container');
    const div = document.createElement('div');
    div.className = 'work-item-row pb-2 mb-1';

    div.innerHTML = `
      <!-- Ligne principale : select + budget + delete -->
      <div class="grid grid-cols-[1fr_7.5rem_2.25rem] sm:grid-cols-[1fr_9rem_2.25rem] gap-2 items-center">
        <div class="relative min-w-0">
          <select class="work-type-select w-full appearance-none rounded-lg border border-slate-200 bg-slate-50 pl-3 pr-7 py-2.5 text-slate-900 text-sm focus:outline-none focus:ring-2 focus:ring-primary/30 focus:border-primary transition-colors cursor-pointer">
            <option value="">Type de travaux‚Ä¶</option>
            ${OPTIONS_HTML}
          </select>
          <svg class="absolute right-2 top-1/2 -translate-y-1/2 h-3.5 w-3.5 text-slate-400 pointer-events-none" fill="none" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor">
            <path stroke-linecap="round" stroke-linejoin="round" d="M19.5 8.25l-7.5 7.5-7.5-7.5"/>
          </svg>
        </div>
        <div class="relative">
          <input
            type="number" min="0" step="500" placeholder="0"
            class="budget-input w-full rounded-lg border border-slate-200 bg-slate-50 px-3 py-2.5 pr-6 text-slate-900 text-sm tabular-nums focus:outline-none focus:ring-2 focus:ring-primary/30 focus:border-primary transition-colors"
          />
          <span class="absolute right-2.5 top-1/2 -translate-y-1/2 text-slate-400 text-xs pointer-events-none">‚Ç¨</span>
        </div>
        <button
          type="button"
          class="delete-row-btn flex items-center justify-center h-9 w-9 rounded-lg text-slate-300 hover:text-red-500 hover:bg-red-50 transition-colors"
          aria-label="Supprimer ce poste"
        >
          <svg class="h-4 w-4" fill="none" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor">
            <path stroke-linecap="round" stroke-linejoin="round" d="M6 18L18 6M6 6l12 12"/>
          </svg>
        </button>
      </div>

      <!-- Champ surface ajout√©e (visible uniquement pour SURFACE_TYPES) -->
      <div class="surface-extra hidden mt-1.5 ml-1 flex items-center gap-2 flex-wrap">
        <label class="text-xs text-amber-700 font-medium flex-shrink-0">Surface cr√©√©e (m¬≤) :</label>
        <div class="relative">
          <input
            type="number" min="1" step="1" placeholder="Ex. 25"
            class="surface-input w-28 rounded-lg border border-amber-300 bg-amber-50/70 px-3 py-1.5 pr-9 text-slate-900 text-sm focus:outline-none focus:ring-2 focus:ring-amber-400/40 focus:border-amber-400 transition-colors"
          />
          <span class="absolute right-2.5 top-1/2 -translate-y-1/2 text-slate-400 text-xs pointer-events-none">m¬≤</span>
        </div>
        <p class="text-xs text-amber-600 italic">Requis pour l'impact locatif</p>
      </div>
    `;

    // Toggle surface-extra sur changement de type
    const typeSelect  = div.querySelector<HTMLSelectElement>('.work-type-select')!;
    const surfaceExtra = div.querySelector<HTMLElement>('.surface-extra')!;
    typeSelect.addEventListener('change', () => {
      if (SURFACE_TYPES.has(typeSelect.value)) {
        surfaceExtra.classList.remove('hidden');
      } else {
        surfaceExtra.classList.add('hidden');
        const si = surfaceExtra.querySelector<HTMLInputElement>('.surface-input');
        if (si) si.value = '';
      }
    });

    const deleteBtn = div.querySelector<HTMLButtonElement>('.delete-row-btn')!;
    deleteBtn.addEventListener('click', () => deleteRow(div));

    container.appendChild(div);
  }

  function deleteRow(row: HTMLElement): void {
    const container = el('work-items-container');
    const rows = container.querySelectorAll('.work-item-row');
    if (rows.length <= 1) {
      (row.querySelector('.work-type-select') as HTMLSelectElement).value = '';
      (row.querySelector('.budget-input')     as HTMLInputElement).value  = '';
      const surfaceExtra = row.querySelector<HTMLElement>('.surface-extra');
      if (surfaceExtra) surfaceExtra.classList.add('hidden');
    } else {
      container.removeChild(row);
    }
  }

  // Collecter les lignes remplies
  function getWorkItems(): WorkItemData[] {
    const rows = document.querySelectorAll<HTMLElement>('.work-item-row');
    const items: WorkItemData[] = [];
    rows.forEach(row => {
      const type   = (row.querySelector('.work-type-select') as HTMLSelectElement).value;
      const budget = parseFloat((row.querySelector('.budget-input') as HTMLInputElement).value) || 0;
      if (type && budget > 0 && WORK_TYPES[type]) {
        const surfaceInput = row.querySelector<HTMLInputElement>('.surface-input');
        const surfaceAdded = SURFACE_TYPES.has(type) && surfaceInput
          ? (parseFloat(surfaceInput.value) || null)
          : null;
        items.push({ type, label: WORK_TYPES[type].label, budget, surfaceAdded });
      }
    });
    return items;
  }

  // ‚îÄ‚îÄ Toggle objectif ‚îÄ‚îÄ
  function setObjective(obj: Objective): void {
    selectedObjective = obj;
    const btnR = el<HTMLButtonElement>('btn-revente');
    const btnL = el<HTMLButtonElement>('btn-location');
    const active   = ['border-primary', 'bg-primary/5', 'text-primary'];
    const inactive = ['border-slate-200', 'bg-slate-50', 'text-slate-500'];

    if (obj === 'revente') {
      active.forEach(c   => btnR.classList.add(c));
      inactive.forEach(c => btnR.classList.remove(c));
      inactive.forEach(c => btnL.classList.add(c));
      active.forEach(c   => btnL.classList.remove(c));
      hide('rent-field');
    } else {
      active.forEach(c   => btnL.classList.add(c));
      inactive.forEach(c => btnL.classList.remove(c));
      inactive.forEach(c => btnR.classList.add(c));
      active.forEach(c   => btnR.classList.remove(c));
      show('rent-field');
    }
    hide('result');
  }

  // ‚îÄ‚îÄ HTML bouton ‚îÄ‚îÄ
  const BTN_IDLE_HTML = `
    <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4 flex-shrink-0" fill="none" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor">
      <path stroke-linecap="round" stroke-linejoin="round" d="M9 7h6m0 10v-3m-3 3h.01M9 17h.01M9 11h.01M12 11h.01M15 11h.01M4.5 19.5l1.5-1.5M19.5 19.5l-1.5-1.5M4.5 4.5l1.5 1.5M19.5 4.5l-1.5 1.5M12 3v1.5M12 19.5V21M3 12h1.5M19.5 12H21" />
    </svg>
    <span>Analyser le projet</span>
  `;
  const BTN_LOADING_HTML = `
    <svg class="h-4 w-4 animate-spin flex-shrink-0" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
      <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"/>
      <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4z"/>
    </svg>
    <span>Analyse en cours‚Ä¶</span>
  `;

  function dispatchScoreEvent(detail: object): void {
    document.dispatchEvent(new CustomEvent('simulateur-scores-update', { detail }));
  }

  // ‚îÄ‚îÄ Calcul principal ‚îÄ‚îÄ
  async function estimate(): Promise<void> {
    const btn       = el<HTMLButtonElement>('btn-estimate');
    const errorEl   = el('form-error');
    const errorText = el('form-error-text');

    const items = getWorkItems();

    if (items.length === 0) {
      errorText.textContent = 'Ajoutez au moins un poste de travaux avec un budget sup√©rieur √† 0.';
      show('form-error');
      return;
    }
    hide('form-error');

    btn.disabled = true;
    btn.innerHTML = BTN_LOADING_HTML;
    dispatchScoreEvent({ status: 'loading' });

    // ‚îÄ‚îÄ Lancer en parall√®le : scores strat√©giques + DVF ‚îÄ‚îÄ
    const propertyValue   = parseFloat(el<HTMLInputElement>('property-value').value)   || 0;
    const currentSurface  = parseFloat(el<HTMLInputElement>('property-surface').value) || 0;
    const zipCode         = (el<HTMLInputElement>('property-zip').value   || '').trim();
    const typeBien        = (el<HTMLSelectElement>('property-type').value || '');

    // Promesse scores
    const scoresPromise = fetch('/api/strategic-scores', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({ items: items.map(i => ({ job_type: i.type, amount_ht: i.budget })) }),
    }).then(r => r.ok ? r.json() : null).catch(() => null);

    // Promesse DVF (uniquement si CP 5 chiffres + type_bien s√©lectionn√©)
    const dvfPromise = (zipCode.length === 5 && typeBien)
      ? fetch('/api/market-prices', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ code_postal: zipCode, type_bien: typeBien }),
        }).then(r => r.ok ? r.json() : null).catch(() => null)
      : Promise.resolve(null);

    const [scoresData, dvfRaw] = await Promise.all([scoresPromise, dvfPromise]);

    // ‚îÄ‚îÄ Traitement scores ‚îÄ‚îÄ
    let weightedRate: number | null = null;
    if (scoresData && typeof scoresData.weighted_recovery_rate === 'number') {
      weightedRate = scoresData.weighted_recovery_rate;
      dispatchScoreEvent({ status: 'done', scores: scoresData });
    } else {
      dispatchScoreEvent({ status: 'error', error: 'Scores indisponibles' });
    }
    if (weightedRate === null) {
      const budgetT = items.reduce((s, i) => s + i.budget, 0);
      const wSum    = items.reduce((s, i) => s + (FALLBACK_RATES[i.type] ?? 0.60) * i.budget, 0);
      weightedRate  = budgetT > 0 ? wSum / budgetT : 0.60;
    }

    // ‚îÄ‚îÄ Traitement DVF ‚îÄ‚îÄ
    const dvfResult: DvfResult | null = (dvfRaw && dvfRaw.available === true) ? dvfRaw as DvfResult : null;

    btn.disabled = false;
    btn.innerHTML = BTN_IDLE_HTML;

    // ‚îÄ‚îÄ Calculs communs ‚îÄ‚îÄ
    const budgetTotal = items.reduce((s, i) => s + i.budget, 0);
    const deltaTotal  = Math.round(budgetTotal * weightedRate);
    const newValue    = propertyValue > 0 ? propertyValue + deltaTotal : 0;
    const dominant    = items.reduce((a, b) => a.budget >= b.budget ? a : b);

    // ‚îÄ‚îÄ Affichage synth√®se ‚îÄ‚îÄ
    el('r-budget-total').textContent  = formatEuro(budgetTotal);
    el('r-delta-value').textContent   = `+${formatEuro(deltaTotal)}`;
    el('r-recovery-pct').textContent  = `${Math.round(weightedRate * 100)}\u202f% r√©cup√©rables`;
    el('r-dominant').textContent      = dominant.label;

    if (propertyValue > 100_000) {
      el('r-new-value').textContent = formatEuro(newValue);
      show('r-new-value-row');
    } else {
      hide('r-new-value-row');
    }

    // ‚îÄ‚îÄ DVF encadr√© ‚îÄ‚îÄ
    hide('r-dvf-box');
    hide('r-dvf-unavailable');

    if (dvfResult) {
      el('r-dvf-price').textContent   = `${dvfResult.prix_m2_estime.toLocaleString('fr-FR')}\u00a0‚Ç¨/m¬≤`;
      el('r-dvf-commune').textContent = dvfResult.commune;
      el('r-dvf-fiabilite').textContent = {
        bon: 'fiabilit√© bonne', moyen: 'fiabilit√© moyenne', faible: 'fiabilit√© faible',
      }[dvfResult.niveau_fiabilite];
      el('r-dvf-nb').textContent = String(dvfResult.nb_transactions);

      // Valeur indicative si surface connue
      if (currentSurface > 0) {
        const valInd = dvfResult.prix_m2_estime * currentSurface;
        el('r-dvf-val-display').textContent = formatEuro(Math.round(valInd));
        show('r-dvf-val-indicative');
      } else {
        hide('r-dvf-val-indicative');
      }
      show('r-dvf-box');
    } else if (zipCode.length === 5 && typeBien) {
      // CP renseign√© mais donn√©es indisponibles
      show('r-dvf-unavailable');
    }

    // ‚îÄ‚îÄ Surcapitalisation ‚îÄ‚îÄ
    const overcapEl = el('r-overcap');

    if (dvfResult && dvfResult.prix_m2_estime > 0) {
      // Mode DVF : comparaison prix/m¬≤ cible vs march√©
      const totalSurfaceAdded = items
        .filter(i => SURFACE_TYPES.has(i.type))
        .reduce((s, i) => s + (i.surfaceAdded ?? 0), 0);
      const finalSurface = (currentSurface + totalSurfaceAdded) || currentSurface;
      const prixM2Cible  = finalSurface > 0 && newValue > 0 ? newValue / finalSurface : null;
      const marche       = dvfResult.prix_m2_estime;

      if (prixM2Cible !== null) {
        const ratio = prixM2Cible / marche;
        if (ratio > 1.20) {
          overcapEl.className = 'mt-4 rounded-lg border border-orange-200 bg-orange-50 p-3.5 text-sm text-orange-800 leading-relaxed';
          overcapEl.innerHTML = `<strong>Risque √©lev√© de surcapitalisation (ETALAB DVF).</strong> Le prix/m¬≤ cible apr√®s travaux est d'environ <strong>${formatEuro(Math.round(prixM2Cible))}/m¬≤</strong>, soit <strong>+${Math.round((ratio - 1) * 100)}&nbsp;%</strong> au-dessus du prix m√©dian du secteur (${formatEuro(marche)}/m¬≤). Le march√© local risque de ne pas absorber cette revalorisation.`;
          show('r-overcap');
        } else if (ratio > 1.10) {
          overcapEl.className = 'mt-4 rounded-lg border border-amber-200 bg-amber-50 p-3.5 text-sm text-amber-800 leading-relaxed';
          overcapEl.innerHTML = `<strong>Vigilance.</strong> Le prix/m¬≤ cible (${formatEuro(Math.round(prixM2Cible))}/m¬≤) d√©passe de ${Math.round((ratio - 1) * 100)}&nbsp;% le march√© local (${formatEuro(marche)}/m¬≤ ‚Äî ETALAB DVF). Comparez avec les biens comparables avant de vous engager.`;
          show('r-overcap');
        } else {
          overcapEl.className = 'mt-4 rounded-lg border border-emerald-200 bg-emerald-50 p-3.5 text-sm text-emerald-800 leading-relaxed';
          overcapEl.innerHTML = `<strong>Prix coh√©rent avec le march√©.</strong> La valeur cible (${formatEuro(Math.round(prixM2Cible))}/m¬≤) reste en ligne avec le prix m√©dian de votre secteur (${formatEuro(marche)}/m¬≤ ‚Äî ETALAB DVF).`;
          show('r-overcap');
        }
      } else if (propertyValue > 0) {
        // Pas de surface, fallback ratio budget/valeur
        const budgetRatio = budgetTotal / propertyValue;
        renderOldOvercap(overcapEl, budgetRatio, newValue);
      } else {
        hide('r-overcap');
      }
    } else if (propertyValue > 0) {
      // Pas de DVF : ratio budget/valeur classique
      const budgetRatio = budgetTotal / propertyValue;
      renderOldOvercap(overcapEl, budgetRatio, newValue);
    } else {
      hide('r-overcap');
    }

    // ‚îÄ‚îÄ D√©tail par poste ‚îÄ‚îÄ
    const tbody = el('r-detail-tbody');
    tbody.innerHTML = items.map(item => {
      const delta = Math.round(item.budget * weightedRate!);
      const surfaceTag = (SURFACE_TYPES.has(item.type) && item.surfaceAdded)
        ? `<span class="ml-1 text-xs text-amber-600">(+${item.surfaceAdded}\u00a0m¬≤)</span>`
        : '';
      return `
        <tr class="border-b border-slate-100 hover:bg-slate-50 transition-colors">
          <td class="py-2.5 pr-2 text-sm text-slate-700">${item.label}${surfaceTag}</td>
          <td class="py-2.5 pr-1 text-right tabular-nums font-mono text-sm text-slate-700 whitespace-nowrap">${formatEuro(item.budget)}</td>
          <td class="py-2.5 text-right tabular-nums font-mono text-sm text-slate-700 whitespace-nowrap">+${formatEuro(delta)}</td>
        </tr>
      `;
    }).join('');

    el('r-total-budget').textContent = formatEuro(budgetTotal);
    el('r-total-delta').textContent  = `+${formatEuro(deltaTotal)}`;

    // ‚îÄ‚îÄ Impact locatif ‚îÄ‚îÄ
    hide('r-location-section');

    if (selectedObjective === 'location') {
      show('r-location-section');

      const currentRent = parseFloat(el<HTMLInputElement>('current-rent').value) || 0;

      // Identifier les postes surface vs non-surface
      const surfaceItems    = items.filter(i => SURFACE_TYPES.has(i.type));
      const nonSurfaceItems = items.filter(i => !SURFACE_TYPES.has(i.type));
      const hasSurfaceWork  = surfaceItems.length > 0;
      const allSurfaceHaveM2 = surfaceItems.every(i => i.surfaceAdded !== null && (i.surfaceAdded ?? 0) > 0);
      const totalSurfaceAdded = surfaceItems.reduce((s, i) => s + (i.surfaceAdded ?? 0), 0);
      const nonSurfaceBudget  = nonSurfaceItems.reduce((s, i) => s + i.budget, 0);

      hide('r-location-missing');
      hide('r-location-surface-warning');
      hide('r-location-note');

      if (!currentRent) {
        // Loyer non renseign√©
        show('r-location-missing');
        ['r-yield-current','r-yield-after','r-new-rent','r-delta-rent','r-delta-rent-annual','r-payback']
          .forEach(id => { el(id).textContent = '‚Äî'; });

      } else if (hasSurfaceWork && !allSurfaceHaveM2) {
        // Extension pr√©sente mais surface ajout√©e manquante
        show('r-location-surface-warning');

        // Afficher le rendement actuel si possible
        const hypoEl = el('r-yield-hypothesis');
        if (hypoEl) hypoEl.textContent = 'Calcul incomplet ‚Äî surface cr√©√©e manquante';

        const yield0 = (propertyValue > 0) ? (currentRent * 12) / propertyValue : null;
        el('r-yield-current').textContent = yield0 !== null ? formatPct(yield0 * 100) : '‚Äî';
        el('r-yield-after').textContent   = '‚Äî';
        el('r-new-rent').textContent      = '‚Äî';
        el('r-delta-rent').textContent    = '‚Äî';
        el('r-delta-rent-annual').textContent = '‚Äî';
        el('r-payback').textContent       = '‚Äî';

      } else {
        // Calcul complet
        const hypoEl = el('r-yield-hypothesis');

        let deltaRentSurface    = 0;
        let deltaRentNonSurface = 0;
        const notes: string[]   = [];

        // ‚îÄ‚îÄ Composante surface (extension/combles) ‚îÄ‚îÄ
        if (hasSurfaceWork && totalSurfaceAdded > 0) {
          let loyerM2: number | null = null;

          if (currentRent > 0 && currentSurface > 0) {
            // Priorit√© 1 : loyer/m¬≤ connu
            loyerM2 = currentRent / currentSurface;
            notes.push(`Extension : loyer au m¬≤ actuel (${formatEuro(Math.round(loyerM2 * 10) / 10)}/m¬≤/mois)`);
          } else if (dvfResult && dvfResult.prix_m2_estime > 0) {
            // Priorit√© 2 : estimation depuis DVF (rendement brut de march√© ~5%)
            loyerM2 = (dvfResult.prix_m2_estime * 0.05) / 12;
            notes.push(`Extension : loyer estim√© depuis DVF (5% rendement brut ¬∑ ${dvfResult.commune})`);
          } else {
            // Fallback prudent : 10 ‚Ç¨/m¬≤/mois
            loyerM2 = 10;
            notes.push('Extension : estimation prudente 10 ‚Ç¨/m¬≤/mois (loyer actuel + surface non renseign√©s)');
          }

          deltaRentSurface = loyerM2 * totalSurfaceAdded;
        }

        // ‚îÄ‚îÄ Composante non-surface (capitalisation, plafonn√©e √† +10%) ‚îÄ‚îÄ
        if (nonSurfaceBudget > 0 && propertyValue > 0) {
          const nonSurfaceProportion = nonSurfaceBudget / budgetTotal;
          const nonSurfaceDelta      = deltaTotal * nonSurfaceProportion;
          const yield0               = (currentRent * 12) / propertyValue;
          const rentContrib          = (nonSurfaceDelta * yield0) / 12;
          deltaRentNonSurface        = Math.min(rentContrib, currentRent * 0.10);

          if (hasSurfaceWork) {
            notes.push(`R√©novation (hors extension) : capitalisation stable, plafonn√©e √† +10%`);
          } else {
            notes.push(`Hypoth√®se : taux de capitalisation stable, hausse de loyer plafonn√©e √† +10%`);
            if (hypoEl) hypoEl.textContent = 'Capitalisation stable ¬∑ hausse plafonn√©e √† +10 %';
          }
        } else if (nonSurfaceBudget > 0 && propertyValue <= 0) {
          notes.push('Renseignez la valeur du bien pour calculer l\'impact locatif des travaux sans surface.');
        }

        if (hasSurfaceWork && nonSurfaceBudget > 0 && hypoEl) {
          hypoEl.textContent = 'Extension : loyer/m¬≤ ¬∑ R√©novation : capitalisation stable';
        } else if (hasSurfaceWork && hypoEl) {
          hypoEl.textContent = 'Estimation au loyer/m¬≤';
        }

        const totalDeltaRent = deltaRentSurface + deltaRentNonSurface;
        const newRentTotal   = currentRent + totalDeltaRent;
        const deltaAnnual    = totalDeltaRent * 12;
        const payback        = totalDeltaRent > 0 ? budgetTotal / deltaAnnual : null;

        const yield0   = propertyValue > 0 ? (currentRent * 12) / propertyValue : null;
        const newYield = (propertyValue + deltaTotal) > 0 ? (newRentTotal * 12) / (propertyValue + deltaTotal) : null;

        el('r-yield-current').textContent = yield0 !== null ? formatPct(yield0 * 100) : '‚Äî';
        el('r-yield-after').textContent   = newYield !== null ? formatPct(newYield * 100) : '‚Äî';
        el('r-new-rent').textContent      = `${formatEuro(Math.round(newRentTotal))}/mois`;

        const sign = totalDeltaRent >= 0 ? '+' : '';
        el('r-delta-rent').textContent        = `${sign}${formatEuro(Math.round(totalDeltaRent))}/mois`;
        el('r-delta-rent-annual').textContent = `${sign}${formatEuro(Math.round(deltaAnnual))}/an`;
        el('r-payback').textContent           = payback !== null ? formatPayback(payback) : '‚Äî';

        if (notes.length > 0) {
          const noteEl = el('r-location-note');
          noteEl.textContent = notes.join(' ¬∑ ');
          show('r-location-note');
        }
      }
    }

    // ‚îÄ‚îÄ Afficher le r√©sultat ‚îÄ‚îÄ
    const resultEl = el('result');
    resultEl.classList.remove('hidden');
    setTimeout(() => resultEl.scrollIntoView({ behavior: 'smooth', block: 'start' }), 80);
  }

  // ‚îÄ‚îÄ Helper surcap classique (sans DVF) ‚îÄ‚îÄ
  function renderOldOvercap(
    el_: HTMLElement,
    ratio: number,
    newValue: number,
  ): void {
    if (ratio > 0.25) {
      el_.className = 'mt-4 rounded-lg border border-orange-200 bg-orange-50 p-3.5 text-sm text-orange-800 leading-relaxed';
      el_.innerHTML = `<strong>Risque √©lev√© de surcapitalisation.</strong> Le budget travaux repr√©sente ${Math.round(ratio * 100)}\u202f% de la valeur du bien. Le march√© local peut ne pas absorber int√©gralement cette revalorisation.${newValue ? ` Comparez la valeur cible (${formatEuro(newValue)}) avec les biens comparables du secteur.` : ''}`;
      show('r-overcap');
    } else if (ratio > 0.15) {
      el_.className = 'mt-4 rounded-lg border border-amber-200 bg-amber-50 p-3.5 text-sm text-amber-800 leading-relaxed';
      el_.innerHTML = `<strong>Attention.</strong> Le budget repr√©sente ${Math.round(ratio * 100)}\u202f% de la valeur du bien.${newValue ? ` V√©rifiez que la valeur cible (${formatEuro(newValue)}) reste coh√©rente avec le plafond de prix de votre secteur.` : ''}`;
      show('r-overcap');
    } else {
      hide('r-overcap');
    }
  }

  // ‚îÄ‚îÄ Init ‚îÄ‚îÄ
  function init(): void {
    addRow();
    el('btn-revente')?.addEventListener('click',  () => setObjective('revente'));
    el('btn-location')?.addEventListener('click', () => setObjective('location'));
    el('add-row-btn')?.addEventListener('click',  addRow);
    el('btn-estimate')?.addEventListener('click', () => { void estimate(); });

    el<HTMLInputElement>('property-value')?.addEventListener('keydown', (e) => {
      if ((e as KeyboardEvent).key === 'Enter') void estimate();
    });
  }

  init();
</script>
