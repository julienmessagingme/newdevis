---
import BaseLayout from '@/layouts/BaseLayout.astro';
import AstroHeader from '@/components/astro/Header.astro';
import AstroFooter from '@/components/astro/Footer.astro';
import SimulateurScoresApp from '@/components/app/SimulateurScoresApp';

const jsonLd = {
  "@context": "https://schema.org",
  "@type": "WebApplication",
  "name": "Simulateur de valorisation des travaux immobiliers",
  "description": "Calculez la revalorisation estim√©e de votre bien selon vos postes de travaux, avec analyse du risque de surcapitalisation.",
  "url": "https://verifiermondevis.fr/simulateur-valorisation-travaux",
  "applicationCategory": "UtilitiesApplication",
  "operatingSystem": "Web",
  "offers": { "@type": "Offer", "price": "0", "priceCurrency": "EUR" }
};
---

<BaseLayout
  title="Simulateur de valorisation des travaux immobiliers | VerifierMonDevis.fr"
  description="Estimez la revalorisation de votre bien poste par poste. Calcul multi-travaux, analyse de surcapitalisation, impact locatif. Gratuit, sans inscription."
  canonical="https://verifiermondevis.fr/simulateur-valorisation-travaux"
  ogType="article"
  jsonLd={jsonLd}
  breadcrumbs={[
    { name: "Accueil",                  url: "https://verifiermondevis.fr/" },
    { name: "Valorisation des travaux", url: "https://verifiermondevis.fr/valorisation-travaux-immobiliers" },
    { name: "Simulateur",               url: "https://verifiermondevis.fr/simulateur-valorisation-travaux" }
  ]}
>
  <div class="min-h-screen flex flex-col">
    <AstroHeader />

    <main class="flex-1">

      <!-- ‚ïê‚ïê HERO ‚ïê‚ïê -->
      <section class="bg-gradient-to-b from-slate-900 to-slate-800 text-white py-12 sm:py-16">
        <div class="container max-w-2xl text-center">
          <a
            href="/valorisation-travaux-immobiliers"
            class="inline-flex items-center gap-1.5 text-slate-400 hover:text-white mb-5 transition-colors text-xs"
          >
            <svg xmlns="http://www.w3.org/2000/svg" class="h-3.5 w-3.5" fill="none" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor">
              <path stroke-linecap="round" stroke-linejoin="round" d="M10.5 19.5L3 12m0 0l7.5-7.5M3 12h18" />
            </svg>
            Guide valorisation des travaux
          </a>
          <h1 class="text-3xl sm:text-4xl font-bold leading-tight mb-3">
            Simulateur de valorisation<br class="hidden sm:block" /> des travaux immobiliers
          </h1>
          <p class="text-slate-300 text-base sm:text-lg leading-relaxed max-w-lg mx-auto">
            Renseignez vos postes de travaux pour estimer la revalorisation globale de votre bien,
            le risque de surcapitalisation et l'impact locatif.
          </p>
        </div>
      </section>

      <!-- ‚ïê‚ïê SIMULATEUR ‚ïê‚ïê -->
      <section class="py-10 sm:py-14 bg-slate-50">
        <div class="container max-w-2xl">

          <!-- ‚îÄ‚îÄ FORMULAIRE ‚îÄ‚îÄ -->
          <div class="bg-white rounded-2xl border border-slate-200 shadow-sm p-6 sm:p-8 mb-6">

            <!-- Section : Contexte -->
            <p class="text-[11px] font-bold uppercase tracking-widest text-slate-400 mb-4">
              Contexte du bien
            </p>

            <div class="grid sm:grid-cols-2 gap-4 mb-6">

              <!-- Valeur actuelle du bien -->
              <div>
                <label for="property-value" class="block text-sm font-semibold text-slate-700 mb-1.5">
                  Valeur actuelle estim√©e du bien (‚Ç¨)
                  <span class="text-xs font-normal text-slate-400 ml-1">‚Äî recommand√©</span>
                </label>
                <div class="relative">
                  <input
                    id="property-value"
                    type="number"
                    min="0"
                    step="5000"
                    placeholder="Ex. 220 000"
                    class="w-full rounded-xl border border-slate-200 bg-slate-50 px-4 py-2.5 pr-10 text-slate-900 text-sm font-medium placeholder:text-slate-400 focus:outline-none focus:ring-2 focus:ring-primary/30 focus:border-primary transition-colors"
                  />
                  <span class="absolute right-3 top-1/2 -translate-y-1/2 text-slate-400 text-xs pointer-events-none">‚Ç¨</span>
                </div>
              </div>

              <!-- Objectif -->
              <div>
                <p class="block text-sm font-semibold text-slate-700 mb-1.5">Objectif</p>
                <div class="flex gap-2">
                  <button
                    id="btn-revente"
                    type="button"
                    class="flex-1 flex items-center justify-center gap-2 rounded-xl border-2 border-primary bg-primary/5 px-3 py-2.5 text-sm font-semibold text-primary transition-all"
                  >
                    <span>üè†</span><span>Revente</span>
                  </button>
                  <button
                    id="btn-location"
                    type="button"
                    class="flex-1 flex items-center justify-center gap-2 rounded-xl border-2 border-slate-200 bg-slate-50 px-3 py-2.5 text-sm font-semibold text-slate-500 transition-all hover:border-slate-300"
                  >
                    <span>üîë</span><span>Location</span>
                  </button>
                </div>
              </div>

            </div>

            <!-- Loyer actuel (Location uniquement) -->
            <div id="rent-field" class="hidden mb-6">
              <label for="current-rent" class="block text-sm font-semibold text-slate-700 mb-1.5">
                Loyer actuel (‚Ç¨/mois)
                <span class="text-xs font-normal text-slate-400 ml-1">‚Äî requis pour l'analyse locative</span>
              </label>
              <div class="relative max-w-xs">
                <input
                  id="current-rent"
                  type="number"
                  min="0"
                  step="50"
                  placeholder="Ex. 800"
                  class="w-full rounded-xl border border-slate-200 bg-slate-50 px-4 py-2.5 pr-16 text-slate-900 text-sm font-medium placeholder:text-slate-400 focus:outline-none focus:ring-2 focus:ring-primary/30 focus:border-primary transition-colors"
                />
                <span class="absolute right-3 top-1/2 -translate-y-1/2 text-slate-400 text-xs pointer-events-none">‚Ç¨/mois</span>
              </div>
            </div>

            <!-- S√©parateur -->
            <div class="border-t border-slate-100 mb-5"></div>

            <!-- Section : Postes de travaux -->
            <p class="text-[11px] font-bold uppercase tracking-widest text-slate-400 mb-3">
              Postes de travaux
            </p>

            <!-- En-t√™tes colonnes (desktop) -->
            <div class="hidden sm:grid sm:grid-cols-[1fr_9rem_2.25rem] gap-2 mb-1.5 px-0.5">
              <p class="text-xs text-slate-400">Type de travaux</p>
              <p class="text-xs text-slate-400">Budget (‚Ç¨)</p>
              <p></p>
            </div>

            <!-- Lignes dynamiques -->
            <div id="work-items-container" class="space-y-2 mb-3"></div>

            <!-- Ajouter un poste -->
            <button
              id="add-row-btn"
              type="button"
              class="flex items-center gap-1.5 text-sm font-medium text-primary hover:text-primary/80 transition-colors py-1 mb-5"
            >
              <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" fill="none" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor">
                <path stroke-linecap="round" stroke-linejoin="round" d="M12 4.5v15m7.5-7.5h-15" />
              </svg>
              Ajouter un poste
            </button>

            <!-- Message d'erreur -->
            <p id="form-error" class="hidden mb-4 text-sm text-red-600 bg-red-50 border border-red-200 rounded-lg px-4 py-2.5">
              <span id="form-error-text">Ajoutez au moins un poste de travaux avec un budget.</span>
            </p>

            <!-- Submit -->
            <button
              id="btn-estimate"
              type="button"
              class="w-full flex items-center justify-center gap-2 bg-slate-900 text-white hover:bg-slate-800 font-semibold rounded-xl px-6 py-3 text-sm transition-colors disabled:opacity-60 disabled:cursor-not-allowed"
            >
              <svg id="btn-estimate-icon" xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" fill="none" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor">
                <path stroke-linecap="round" stroke-linejoin="round" d="M9 7h6m0 10v-3m-3 3h.01M9 17h.01M9 11h.01M12 11h.01M15 11h.01M4.5 19.5l1.5-1.5M19.5 19.5l-1.5-1.5M4.5 4.5l1.5 1.5M19.5 4.5l-1.5 1.5M12 3v1.5M12 19.5V21M3 12h1.5M19.5 12H21" />
              </svg>
              <span id="btn-estimate-label">Analyser le projet</span>
            </button>

          </div>

          <!-- ‚îÄ‚îÄ R√âSULTAT ‚îÄ‚îÄ -->
          <div
            id="result"
            class="hidden bg-white rounded-2xl border border-slate-200 shadow-sm overflow-hidden"
            aria-live="polite"
            aria-atomic="true"
          >

            <!-- ‚îÄ‚îÄ Synth√®se financi√®re ‚îÄ‚îÄ -->
            <div class="p-6 sm:p-8">

              <p class="text-[11px] font-bold uppercase tracking-widest text-slate-400 mb-4">
                Synth√®se financi√®re
              </p>

              <div class="divide-y divide-slate-100">

                <div class="flex items-center justify-between py-3 gap-4">
                  <span class="text-sm text-slate-600">Budget total travaux</span>
                  <span id="r-budget-total" class="text-sm font-bold tabular-nums font-mono text-slate-900"></span>
                </div>

                <div class="flex items-center justify-between py-3 gap-4">
                  <span class="text-sm text-slate-600">Revalorisation estim√©e</span>
                  <div class="flex items-baseline gap-2 flex-shrink-0">
                    <span id="r-delta-value" class="text-sm font-bold tabular-nums font-mono text-slate-900"></span>
                    <span id="r-recovery-pct" class="text-xs text-slate-400"></span>
                  </div>
                </div>

                <div id="r-new-value-row" class="hidden flex items-center justify-between py-3 gap-4">
                  <span class="text-sm text-slate-600">Valeur estim√©e apr√®s travaux</span>
                  <span id="r-new-value" class="text-sm font-bold tabular-nums font-mono text-slate-900"></span>
                </div>

                <div class="flex items-center justify-between py-3 gap-4">
                  <span class="text-sm text-slate-600">Nature dominante du projet</span>
                  <span id="r-dominant" class="text-sm font-medium text-slate-700 text-right max-w-[55%]"></span>
                </div>

              </div>

              <!-- Surcapitalisation -->
              <div id="r-overcap" class="hidden mt-4 rounded-lg border p-3.5 text-sm leading-relaxed"></div>

            </div>

            <!-- ‚îÄ‚îÄ Impact locatif ‚îÄ‚îÄ -->
            <div id="r-location-section" class="hidden border-t border-slate-200 bg-slate-50 p-6 sm:p-8">

              <p class="text-[11px] font-bold uppercase tracking-widest text-slate-400 mb-4">
                Impact locatif
              </p>

              <div class="divide-y divide-slate-200">

                <div class="flex items-center justify-between py-3 gap-4">
                  <span class="text-sm text-slate-600">Rendement brut actuel</span>
                  <span id="r-yield-current" class="text-sm font-bold tabular-nums font-mono text-slate-900"></span>
                </div>

                <div class="flex items-start justify-between py-3 gap-4">
                  <div>
                    <p class="text-sm text-slate-600">Rendement brut apr√®s travaux</p>
                    <p class="text-xs text-slate-400 italic mt-0.5">Hypoth√®se : taux de capitalisation stable</p>
                  </div>
                  <span id="r-yield-after" class="text-sm font-bold tabular-nums font-mono text-slate-900 flex-shrink-0"></span>
                </div>

                <div class="flex items-center justify-between py-3 gap-4">
                  <span class="text-sm text-slate-600">Loyer estim√© apr√®s travaux</span>
                  <span id="r-new-rent" class="text-sm font-bold tabular-nums font-mono text-slate-900 flex-shrink-0"></span>
                </div>

                <div class="flex items-center justify-between py-3 gap-4">
                  <span class="text-sm text-slate-600">Surplus mensuel</span>
                  <span id="r-delta-rent" class="text-sm font-bold tabular-nums font-mono text-slate-900 flex-shrink-0"></span>
                </div>

                <div class="flex items-center justify-between py-3 gap-4">
                  <span class="text-sm text-slate-600">Surplus annuel</span>
                  <span id="r-delta-rent-annual" class="text-sm font-bold tabular-nums font-mono text-slate-900 flex-shrink-0"></span>
                </div>

                <div class="flex items-center justify-between py-3 gap-4">
                  <span class="text-sm text-slate-600">Amortissement estim√©</span>
                  <span id="r-payback" class="text-sm font-bold tabular-nums font-mono text-slate-900 flex-shrink-0"></span>
                </div>

              </div>

              <!-- Alerte donn√©es manquantes -->
              <div id="r-location-missing" class="hidden mt-4 rounded-lg border border-slate-200 bg-white p-3 text-xs text-slate-500 italic">
                Renseignez la valeur du bien et le loyer actuel pour calculer l'impact locatif.
              </div>

            </div>

            <!-- ‚îÄ‚îÄ D√©tail par poste ‚îÄ‚îÄ -->
            <div class="border-t border-slate-200 p-6 sm:p-8">

              <p class="text-[11px] font-bold uppercase tracking-widest text-slate-400 mb-4">
                D√©tail par poste
              </p>

              <div class="overflow-x-auto">
                <table class="w-full text-sm">
                  <thead>
                    <tr class="border-b border-slate-200">
                      <th class="text-left pb-2 text-xs font-semibold text-slate-400 uppercase tracking-wider">Travaux</th>
                      <th class="text-right pb-2 text-xs font-semibold text-slate-400 uppercase tracking-wider pr-1">Budget</th>
                      <th class="text-right pb-2 text-xs font-semibold text-slate-400 uppercase tracking-wider">R√©cup. est.</th>
                    </tr>
                  </thead>
                  <tbody id="r-detail-tbody">
                    <!-- filled by JS -->
                  </tbody>
                  <tfoot>
                    <tr class="border-t-2 border-slate-300">
                      <td class="pt-3 pb-1 text-sm font-bold text-slate-900">Total</td>
                      <td id="r-total-budget" class="pt-3 pb-1 text-right text-sm font-bold tabular-nums font-mono text-slate-900 pr-1"></td>
                      <td id="r-total-delta"  class="pt-3 pb-1 text-right text-sm font-bold tabular-nums font-mono text-slate-900"></td>
                    </tr>
                  </tfoot>
                </table>
              </div>

            </div>

            <!-- ‚îÄ‚îÄ Indice Strat√©gique Immobilier‚Ñ¢ (island React) ‚îÄ‚îÄ -->
            <div id="r-strategic-section" class="border-t border-slate-200 p-6 sm:p-8">
              <p class="text-[11px] font-bold uppercase tracking-widest text-slate-400 mb-4">
                Indice Strat√©gique Immobilier‚Ñ¢
              </p>
              <SimulateurScoresApp client:only="react" />
            </div>

            <!-- ‚îÄ‚îÄ CTA + mention l√©gale ‚îÄ‚îÄ -->
            <div class="border-t border-slate-200 bg-slate-50 p-6 sm:p-8">

              <a
                href="/nouvelle-analyse"
                class="w-full flex items-center justify-center gap-2 bg-primary text-primary-foreground hover:bg-primary/90 font-semibold rounded-xl px-6 py-3 text-sm transition-colors mb-4"
              >
                <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4 flex-shrink-0" fill="none" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor">
                  <path stroke-linecap="round" stroke-linejoin="round" d="M3 16.5v2.25A2.25 2.25 0 005.25 21h13.5A2.25 2.25 0 0021 18.75V16.5m-13.5-9L12 3m0 0l4.5 4.5M12 3v13.5" />
                </svg>
                Analyser mon devis pour une estimation bas√©e sur mes prix r√©els
              </a>

              <p class="text-xs text-slate-400 italic leading-relaxed">
                Les taux de r√©cup√©ration sont des ordres de grandeur issus d'observations du march√© immobilier fran√ßais.
                Ils ne constituent pas une estimation professionnelle. Les r√©sultats varient selon la localisation pr√©cise,
                la qualit√© d'ex√©cution, l'√©tat initial du bien et les conditions du march√© local au moment de la vente ou de la mise en location.
              </p>

            </div>

          </div>

        </div>
      </section>

      <!-- ‚ïê‚ïê EXPLICATION ‚ïê‚ïê -->
      <section class="py-10 sm:py-12 border-t border-slate-200">
        <div class="container max-w-2xl">
          <p class="text-[11px] font-bold uppercase tracking-widest text-slate-400 mb-3">M√©thodologie</p>
          <p class="text-sm text-slate-600 leading-relaxed mb-3">
            Chaque poste est √©valu√© via l'<strong>Indice Strat√©gique Immobilier‚Ñ¢</strong> (IVP / IPI) calcul√© depuis
            notre r√©f√©rentiel de plus de 300 types de travaux. Le <strong>taux de r√©cup√©ration pond√©r√©</strong>
            retourn√© par l'analyse est appliqu√© uniform√©ment au budget de chaque poste.
            En mode Location, le mod√®le suppose un <strong>taux de capitalisation stable</strong> : si la valeur
            du bien augmente de X&nbsp;%, le loyer de march√© augmente du m√™me pourcentage.
          </p>
          <p class="text-sm text-slate-600 leading-relaxed">
            Pour une estimation bas√©e sur les postes exacts de votre devis et les prix du march√© dans votre secteur,
            utilisez l'analyse compl√®te.
          </p>
          <div class="flex flex-wrap gap-3 text-sm mt-5">
            <a href="/nouvelle-analyse" class="inline-flex items-center gap-1.5 bg-primary text-primary-foreground hover:bg-primary/90 px-4 py-2 rounded-lg font-medium transition-colors">
              Analyser mon devis
            </a>
            <a href="/valorisation-travaux-immobiliers" class="inline-flex items-center gap-1.5 border border-slate-300 text-slate-700 hover:bg-slate-50 px-4 py-2 rounded-lg transition-colors">
              Guide valorisation
            </a>
          </div>
        </div>
      </section>

    </main>

    <AstroFooter />
  </div>
</BaseLayout>

<!-- ‚ïê‚ïê LOGIQUE SIMULATEUR V4 ‚ïê‚ïê -->
<script>
  // ‚îÄ‚îÄ Types ‚îÄ‚îÄ
  type Objective = 'revente' | 'location';

  interface WorkTypeDef {
    label: string;
  }

  interface WorkItemData {
    type:   string;
    label:  string;
    budget: number;
  }

  // ‚îÄ‚îÄ R√©f√©rentiel des types de travaux (labels only ‚Äî taux via API) ‚îÄ‚îÄ
  const WORK_TYPES: Record<string, WorkTypeDef> = {
    extension:              { label: "Extension / sur√©l√©vation" },
    combles:                { label: "Am√©nagement des combles" },
    renovation_energetique: { label: "R√©novation √©nerg√©tique globale" },
    isolation:              { label: "Isolation thermique" },
    toiture:                { label: "Toiture / charpente" },
    assainissement:         { label: "Assainissement / plomberie" },
    redistribution:         { label: "Redistribution des espaces" },
    veranda:                { label: "V√©randa / pergola" },
    electricite:            { label: "√âlectricit√© / mise aux normes" },
    photovoltaique:         { label: "Panneaux photovolta√Øques" },
    cuisine:                { label: "Cuisine" },
    salle_bain:             { label: "Salle de bain" },
    terrasse:               { label: "Terrasse / ext√©rieurs" },
    climatisation:          { label: "Climatisation / chauffage" },
    piscine:                { label: "Piscine" },
  };

  // Taux de r√©cup√©ration de repli (si API indisponible)
  const FALLBACK_RATES: Record<string, number> = {
    extension: 0.85, combles: 0.80, renovation_energetique: 0.80,
    isolation: 0.70, toiture: 0.70, assainissement: 0.70,
    redistribution: 0.60, veranda: 0.60, electricite: 0.60, photovoltaique: 0.60,
    cuisine: 0.50, salle_bain: 0.50, terrasse: 0.50,
    climatisation: 0.40, piscine: 0.40,
  };

  // Options HTML pour les selects (g√©n√©r√© une seule fois)
  const OPTIONS_HTML: string = Object.entries(WORK_TYPES)
    .map(([k, v]) => `<option value="${k}">${v.label}</option>`)
    .join('');

  // ‚îÄ‚îÄ Utilitaires ‚îÄ‚îÄ
  function formatEuro(n: number): string {
    return new Intl.NumberFormat('fr-FR', {
      style: 'currency', currency: 'EUR', maximumFractionDigits: 0
    }).format(n);
  }

  function formatPct(n: number, decimals = 1): string {
    return n.toFixed(decimals).replace('.', ',') + '\u202f%';
  }

  function formatPayback(years: number): string {
    if (years >= 30) return '> 30 ans';
    if (years >= 10) return `${Math.round(years)}\u00a0ans`;
    return `${years.toFixed(1).replace('.', ',')}\u00a0ans`;
  }

  function el<T extends HTMLElement = HTMLElement>(id: string): T {
    return document.getElementById(id) as T;
  }

  function show(id: string): void { el(id).classList.remove('hidden'); }
  function hide(id: string): void { el(id).classList.add('hidden');    }

  // ‚îÄ‚îÄ √âtat ‚îÄ‚îÄ
  let selectedObjective: Objective = 'revente';

  // ‚îÄ‚îÄ Gestion des lignes de travaux ‚îÄ‚îÄ
  function addRow(): void {
    const container = el('work-items-container');

    const div = document.createElement('div');
    div.className = 'work-item-row grid grid-cols-[1fr_7.5rem_2.25rem] sm:grid-cols-[1fr_9rem_2.25rem] gap-2 items-center';
    div.innerHTML = `
      <div class="relative min-w-0">
        <select class="work-type-select w-full appearance-none rounded-lg border border-slate-200 bg-slate-50 pl-3 pr-7 py-2.5 text-slate-900 text-sm focus:outline-none focus:ring-2 focus:ring-primary/30 focus:border-primary transition-colors cursor-pointer">
          <option value="">Type de travaux‚Ä¶</option>
          ${OPTIONS_HTML}
        </select>
        <svg class="absolute right-2 top-1/2 -translate-y-1/2 h-3.5 w-3.5 text-slate-400 pointer-events-none" fill="none" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor">
          <path stroke-linecap="round" stroke-linejoin="round" d="M19.5 8.25l-7.5 7.5-7.5-7.5"/>
        </svg>
      </div>
      <div class="relative">
        <input
          type="number" min="0" step="500" placeholder="0"
          class="budget-input w-full rounded-lg border border-slate-200 bg-slate-50 px-3 py-2.5 pr-6 text-slate-900 text-sm tabular-nums focus:outline-none focus:ring-2 focus:ring-primary/30 focus:border-primary transition-colors"
        />
        <span class="absolute right-2.5 top-1/2 -translate-y-1/2 text-slate-400 text-xs pointer-events-none">‚Ç¨</span>
      </div>
      <button
        type="button"
        class="delete-row-btn flex items-center justify-center h-9 w-9 rounded-lg text-slate-300 hover:text-red-500 hover:bg-red-50 transition-colors"
        aria-label="Supprimer ce poste"
      >
        <svg class="h-4 w-4" fill="none" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor">
          <path stroke-linecap="round" stroke-linejoin="round" d="M6 18L18 6M6 6l12 12"/>
        </svg>
      </button>
    `;

    const deleteBtn = div.querySelector<HTMLButtonElement>('.delete-row-btn')!;
    deleteBtn.addEventListener('click', () => deleteRow(div));

    container.appendChild(div);
  }

  function deleteRow(row: HTMLElement): void {
    const container = el('work-items-container');
    const rows = container.querySelectorAll('.work-item-row');
    if (rows.length <= 1) {
      (row.querySelector('.work-type-select') as HTMLSelectElement).value = '';
      (row.querySelector('.budget-input')     as HTMLInputElement).value  = '';
    } else {
      container.removeChild(row);
    }
  }

  // Collecter les lignes remplies
  function getWorkItems(): WorkItemData[] {
    const rows = document.querySelectorAll<HTMLElement>('.work-item-row');
    const items: WorkItemData[] = [];
    rows.forEach(row => {
      const type   = (row.querySelector('.work-type-select') as HTMLSelectElement).value;
      const budget = parseFloat((row.querySelector('.budget-input') as HTMLInputElement).value) || 0;
      if (type && budget > 0 && WORK_TYPES[type]) {
        items.push({ type, label: WORK_TYPES[type].label, budget });
      }
    });
    return items;
  }

  // ‚îÄ‚îÄ Toggle objectif ‚îÄ‚îÄ
  function setObjective(obj: Objective): void {
    selectedObjective = obj;
    const btnR = el<HTMLButtonElement>('btn-revente');
    const btnL = el<HTMLButtonElement>('btn-location');

    const active   = ['border-primary', 'bg-primary/5', 'text-primary'];
    const inactive = ['border-slate-200', 'bg-slate-50', 'text-slate-500'];

    if (obj === 'revente') {
      active.forEach(c   => btnR.classList.add(c));
      inactive.forEach(c => btnR.classList.remove(c));
      inactive.forEach(c => btnL.classList.add(c));
      active.forEach(c   => btnL.classList.remove(c));
      hide('rent-field');
    } else {
      active.forEach(c   => btnL.classList.add(c));
      inactive.forEach(c => btnL.classList.remove(c));
      inactive.forEach(c => btnR.classList.add(c));
      active.forEach(c   => btnR.classList.remove(c));
      show('rent-field');
    }

    hide('result');
  }

  // ‚îÄ‚îÄ Helpers bouton ‚îÄ‚îÄ
  const BTN_IDLE_HTML = `
    <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4 flex-shrink-0" fill="none" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor">
      <path stroke-linecap="round" stroke-linejoin="round" d="M9 7h6m0 10v-3m-3 3h.01M9 17h.01M9 11h.01M12 11h.01M15 11h.01M4.5 19.5l1.5-1.5M19.5 19.5l-1.5-1.5M4.5 4.5l1.5 1.5M19.5 4.5l-1.5 1.5M12 3v1.5M12 19.5V21M3 12h1.5M19.5 12H21" />
    </svg>
    <span>Analyser le projet</span>
  `;
  const BTN_LOADING_HTML = `
    <svg class="h-4 w-4 animate-spin flex-shrink-0" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
      <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"/>
      <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4z"/>
    </svg>
    <span>Analyse en cours‚Ä¶</span>
  `;

  function dispatchScoreEvent(detail: object): void {
    document.dispatchEvent(new CustomEvent('simulateur-scores-update', { detail }));
  }

  // ‚îÄ‚îÄ Calcul principal ‚îÄ‚îÄ
  async function estimate(): Promise<void> {
    const btn       = el<HTMLButtonElement>('btn-estimate');
    const errorEl   = el('form-error');
    const errorText = el('form-error-text');

    const items = getWorkItems();

    if (items.length === 0) {
      errorText.textContent = 'Ajoutez au moins un poste de travaux avec un budget sup√©rieur √† 0.';
      show('form-error');
      return;
    }
    hide('form-error');

    // ‚îÄ‚îÄ Mettre le bouton en mode chargement ‚îÄ‚îÄ
    btn.disabled = true;
    btn.innerHTML = BTN_LOADING_HTML;
    dispatchScoreEvent({ status: 'loading' });

    // ‚îÄ‚îÄ Appel API /api/strategic-scores ‚îÄ‚îÄ
    let weightedRate: number | null = null;
    let apiScores: object | null = null;

    try {
      const resp = await fetch('/api/strategic-scores', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({
          items: items.map(i => ({ job_type: i.type, amount_ht: i.budget }))
        }),
      });

      if (resp.ok) {
        const data = await resp.json();
        if (typeof data.weighted_recovery_rate === 'number') {
          weightedRate = data.weighted_recovery_rate;
        }
        apiScores = data;
        dispatchScoreEvent({ status: 'done', scores: data });
      } else {
        dispatchScoreEvent({ status: 'error', error: `HTTP ${resp.status}` });
      }
    } catch (err) {
      dispatchScoreEvent({ status: 'error', error: 'R√©seau indisponible' });
    }

    // ‚îÄ‚îÄ Fallback si API √©chou√©e ‚îÄ‚îÄ
    if (weightedRate === null) {
      const budgetTotal  = items.reduce((s, i) => s + i.budget, 0);
      const weightedSum  = items.reduce((s, i) => s + (FALLBACK_RATES[i.type] ?? 0.60) * i.budget, 0);
      weightedRate = budgetTotal > 0 ? weightedSum / budgetTotal : 0.60;
    }

    // ‚îÄ‚îÄ Restaurer le bouton ‚îÄ‚îÄ
    btn.disabled = false;
    btn.innerHTML = BTN_IDLE_HTML;

    // ‚îÄ‚îÄ Totaux ‚îÄ‚îÄ
    const budgetTotal = items.reduce((s, i) => s + i.budget, 0);
    const deltaTotal  = Math.round(budgetTotal * weightedRate);

    // ‚îÄ‚îÄ Nature dominante (poste avec le plus gros budget) ‚îÄ‚îÄ
    const dominant = items.reduce((a, b) => a.budget >= b.budget ? a : b);

    // ‚îÄ‚îÄ Valeur du bien ‚îÄ‚îÄ
    const propertyValue = parseFloat(el<HTMLInputElement>('property-value').value) || 0;
    const newValue      = propertyValue > 0 ? propertyValue + deltaTotal : 0;

    // ‚îÄ‚îÄ Affichage synth√®se ‚îÄ‚îÄ
    el('r-budget-total').textContent  = formatEuro(budgetTotal);
    el('r-delta-value').textContent   = `+${formatEuro(deltaTotal)}`;
    el('r-recovery-pct').textContent  = `${Math.round(weightedRate * 100)}\u202f% r√©cup√©rables`;
    el('r-dominant').textContent      = dominant.label;

    if (propertyValue > 100000) {
      el('r-new-value').textContent = formatEuro(newValue);
      show('r-new-value-row');
    } else {
      hide('r-new-value-row');
    }

    // ‚îÄ‚îÄ Surcapitalisation ‚îÄ‚îÄ
    const overcapEl = el('r-overcap');
    if (propertyValue > 0) {
      const ratio = budgetTotal / propertyValue;
      if (ratio > 0.25) {
        overcapEl.className = 'mt-4 rounded-lg border border-orange-200 bg-orange-50 p-3.5 text-sm text-orange-800 leading-relaxed';
        overcapEl.innerHTML = `<strong>Risque √©lev√© de surcapitalisation.</strong> Le budget travaux repr√©sente ${Math.round(ratio * 100)}\u202f% de la valeur du bien. Le march√© local peut ne pas absorber int√©gralement cette revalorisation. Comparez la valeur cible (${formatEuro(newValue)}) avec les biens comparables du secteur avant de vous engager.`;
        show('r-overcap');
      } else if (ratio > 0.15) {
        overcapEl.className = 'mt-4 rounded-lg border border-amber-200 bg-amber-50 p-3.5 text-sm text-amber-800 leading-relaxed';
        overcapEl.innerHTML = `<strong>Attention.</strong> Le budget repr√©sente ${Math.round(ratio * 100)}\u202f% de la valeur du bien. V√©rifiez que la valeur cible (${formatEuro(newValue)}) reste coh√©rente avec le plafond de prix de votre secteur.`;
        show('r-overcap');
      } else {
        hide('r-overcap');
      }
    } else {
      hide('r-overcap');
    }

    // ‚îÄ‚îÄ D√©tail par poste ‚îÄ‚îÄ
    const tbody = el('r-detail-tbody');
    tbody.innerHTML = items.map(item => {
      const delta = Math.round(item.budget * weightedRate!);
      return `
        <tr class="border-b border-slate-100 hover:bg-slate-50 transition-colors">
          <td class="py-2.5 pr-2 text-sm text-slate-700">${item.label}</td>
          <td class="py-2.5 pr-1 text-right tabular-nums font-mono text-sm text-slate-700 whitespace-nowrap">${formatEuro(item.budget)}</td>
          <td class="py-2.5 text-right tabular-nums font-mono text-sm text-slate-700 whitespace-nowrap">+${formatEuro(delta)}</td>
        </tr>
      `;
    }).join('');

    el('r-total-budget').textContent = formatEuro(budgetTotal);
    el('r-total-delta').textContent  = `+${formatEuro(deltaTotal)}`;

    // ‚îÄ‚îÄ Impact locatif ‚îÄ‚îÄ
    hide('r-location-section');
    hide('r-location-missing');

    if (selectedObjective === 'location') {
      show('r-location-section');

      const currentRent = parseFloat(el<HTMLInputElement>('current-rent').value) || 0;

      if (propertyValue > 0 && currentRent > 0 && newValue > 0) {
        hide('r-location-missing');

        const yield0      = (currentRent * 12) / propertyValue;
        const newRent     = (newValue * yield0) / 12;
        const deltaRent   = newRent - currentRent;
        const deltaAnnual = deltaRent * 12;
        const payback     = deltaRent > 0 ? budgetTotal / deltaAnnual : null;

        el('r-yield-current').textContent     = formatPct(yield0 * 100);
        el('r-yield-after').textContent       = formatPct(yield0 * 100);
        el('r-new-rent').textContent          = `${formatEuro(Math.round(newRent))}/mois`;
        el('r-delta-rent').textContent        = `+${formatEuro(Math.round(deltaRent))}/mois`;
        el('r-delta-rent-annual').textContent = `+${formatEuro(Math.round(deltaAnnual))}/an`;
        el('r-payback').textContent           = payback !== null ? formatPayback(payback) : '‚Äî';

      } else {
        show('r-location-missing');
        ['r-yield-current', 'r-yield-after', 'r-new-rent', 'r-delta-rent', 'r-delta-rent-annual', 'r-payback']
          .forEach(id => { el(id).textContent = '‚Äî'; });
      }
    }

    // ‚îÄ‚îÄ Afficher le r√©sultat ‚îÄ‚îÄ
    const resultEl = el('result');
    resultEl.classList.remove('hidden');
    setTimeout(() => {
      resultEl.scrollIntoView({ behavior: 'smooth', block: 'start' });
    }, 80);
  }

  // ‚îÄ‚îÄ Init + Event listeners ‚îÄ‚îÄ
  function init(): void {
    addRow();

    el('btn-revente')?.addEventListener('click',  () => setObjective('revente'));
    el('btn-location')?.addEventListener('click', () => setObjective('location'));
    el('add-row-btn')?.addEventListener('click',  addRow);
    el('btn-estimate')?.addEventListener('click', () => { estimate(); });

    el<HTMLInputElement>('property-value')?.addEventListener('keydown', (e) => {
      if ((e as KeyboardEvent).key === 'Enter') estimate();
    });
  }

  init();
</script>
